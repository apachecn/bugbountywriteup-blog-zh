# å®‰å“æµ‹è¯•å®éªŒå®¤

> åŸæ–‡ï¼š<https://infosecwriteups.com/android-pentesting-lab-4a6fe1a1d2e0?source=collection_archive---------0----------------------->

## åˆå­¦è€…å¾ªåºæ¸è¿›æŒ‡å—ï¼

![](img/7bd5e0eb6565c0b703673f352a3a677d.png)

# ä»‹ç»

ä½œä¸ºä¸€ä¸ªåœ£çµé™ä¸´è€…ï¼Œåœ¨ä¸åŒçš„é¢†åŸŸå‘å±•æ–°çš„æŠ€èƒ½æ˜¯éå¸¸é‡è¦çš„ï¼Œå› ä¸ºä½ å¯èƒ½ä¼šä»ä¸€ç§æ–¹æ³•ä¸­é”™è¿‡ä¸€äº›é‡è¦çš„ä¸œè¥¿ã€‚Android pentesting å°±æ˜¯å…¶ä¸­ä¹‹ä¸€ï¼Œä½†å®ƒéœ€è¦ä¸€ä¸ªä¸“ç”¨çš„ç¯å¢ƒï¼Œæˆ‘å°†è§£é‡Šå¦‚ä½•è®¾ç½®ä¸€ä¸ªç®€å•çš„ç¯å¢ƒã€‚æ‰€ä»¥è®©æˆ‘ä»¬å¼€å§‹å§ï¼

**ç›®å½•:**

*   è®¾ç½® android æ¨¡æ‹Ÿå™¨(Genymotion)
*   åœ¨è®¾å¤‡ä¸Šé…ç½® Burp Suite CA è¯ä¹¦
*   Frida ç»•è¿‡ SSL å›ºå®š
*   å­—èŠ‚ç æŸ¥çœ‹å™¨(ç”¨äºé™æ€åˆ†æ)

> åœ¨å®‰è£…æ¨¡æ‹Ÿå™¨ä¹‹å‰ï¼Œæˆ‘å»ºè®®å®‰è£…ä»»ä½•åŸºäº Linux çš„å‘è¡Œç‰ˆæˆ– [Santoku](https://santoku-linux.com/) ï¼Œè¿™æ˜¯ä¸“é—¨ä¸ºç§»åŠ¨æµ‹è¯•è®¾è®¡çš„ã€‚å®‰è£… Santoku è¶…å‡ºäº†æœ¬æ–‡çš„èŒƒå›´ï¼Œä½†æ˜¯æ‚¨å¯ä»¥æŒ‰ç…§æœ¬ æŒ‡å—ä¸­çš„ [**è¿›è¡Œå®‰è£…ã€‚**](https://santoku-linux.com/howto/installing-santoku/installing-santoku-in-a-virtual-machine/)

# 1.åŸºå› è¿åŠ¨

å½“å¼€å§‹å­¦ä¹ æ—¶ï¼Œandroid æ¨¡æ‹Ÿå™¨æ˜¯è·å¾—å„ç§å…·æœ‰ä¸åŒ API çº§åˆ«çš„è®¾å¤‡çš„ç»éªŒçš„å¥½æ–¹æ³•ï¼Œè€Œä¸éœ€è¦èŠ±è´¹å¤ªå¤šï¼Œå…è´¹ç‰ˆæœ¬çš„ Genymotion æä¾›äº†å¾ˆå¥½çš„ç”¨æˆ·ä½“éªŒå’Œæ˜“äºé…ç½®çš„ç‰¹æ€§ã€‚

> æ³¨:VirtualBox è¢« genymotion ç”¨ä½œæ ¸å¿ƒï¼Œè™šæ‹ŸåŒ– Android æ“ä½œç³»ç»Ÿã€‚å› æ­¤ï¼Œè¯·åœ¨æ‚¨çš„ç³»ç»Ÿä¸­å®‰è£… VirtualBox ä»¥ä¾¿ç»§ç»­:[é“¾æ¥](https://www.virtualbox.org/wiki/Downloads)

Genymotion éœ€è¦ç”¨æˆ·æ³¨å†Œæ‰èƒ½ä½¿ç”¨å®ƒçš„ä»ªè¡¨æ¿ï¼Œé¦–å…ˆä½ éœ€è¦åˆ›å»ºä¸€ä¸ªå¸æˆ·:[é“¾æ¥](https://www.genymotion.com/account/create/)

å®Œæˆæ³¨å†Œè¿‡ç¨‹åï¼Œä»[è¿™é‡Œ](https://www.genymotion.com/download/)ä¸‹è½½å…¶å®‰è£…ç¨‹åºï¼Œå¹¶å°†å…¶å®‰è£…åœ¨æ‚¨çš„ä¸»æœºä¸Šã€‚

```
# Make it executable
$- **chmod +x genymotion-<version>-linux_x64.bin**# Specify your path, here i am installing in user's home directory
$- **./genymotion-<version>-linux_x64.bin -d ~/**
```

ä¸€æ—¦ Genymotion å®‰è£…å®Œæ¯•ï¼Œæ‚¨å°±å¯ä»¥ä½¿ç”¨æ³¨å†Œè¿‡ç¨‹ä¸­æŒ‡å®šçš„å‡­æ®ç™»å½•ï¼Œå¹¶ä½¿ç”¨å…¶ä»ªè¡¨æ¿ï¼Œå¦‚å›¾ 1 æ‰€ç¤ºã€‚

![](img/1b4bf53a8857ffd8c3681b8f2685eb5c.png)

å›¾ä¸€ã€‚Genymotion ä»ªè¡¨æ¿

åœ¨è¿™é‡Œï¼Œæˆ‘å·²ç»å®‰è£…äº†ä¸¤ä¸ªè®¾å¤‡ï¼Œä½†æ˜¯æ‚¨å¯ä»¥é€šè¿‡å•å‡»å³ä¸Šè§’çš„åŠ å·å›¾æ ‡å¹¶é€‰æ‹©æ‚¨æƒ³è¦çš„æ¨¡æ¿æ¥å®‰è£…æ–°è®¾å¤‡ï¼Œå¯¹äºæ­¤ç¤ºä¾‹ï¼Œæˆ‘å°†å®‰è£…ä¸‰æ˜Ÿ Galaxy S9 (8.0 â€” API 26)

![](img/9fa03f21001248aa9b7dcb737977159d.png)

å›¾äºŒã€‚å®‰è£…ä¸‰æ˜Ÿ galaxy s9

## é…ç½® Genymotion

å¯åŠ¨è£…ç½®åï¼Œæœ‰å‡ ä»¶äº‹éœ€è¦è€ƒè™‘:

*   **ARM ç¿»è¯‘å™¨:**

å¦‚æœæŸä¸ªåº”ç”¨ç¨‹åºåŒ…å« ARM æœ¬æœºä»£ç ï¼Œé‚£ä¹ˆ Genymotion å°†æ— æ³•è¿è¡Œè¯¥åº”ç”¨ç¨‹åºï¼Œå› ä¸ºå®ƒç”± x86 (32 ä½)æ¶æ„ç»„æˆï¼Œå¹¶å°†å¼•å‘é”™è¯¯ã€‚å¯ä»¥é€šè¿‡åœ¨ä»¿çœŸè®¾å¤‡ä¸­å®‰è£… ARM ç¿»è¯‘åº“æ¥é¿å…è¿™ä¸ªé—®é¢˜: [link](https://github.com/m9rco/Genymotion_ARM_Translation)

> **æ³¨æ„:**ç›®å‰è¿™ä¸ªåº“åªæ”¯æŒ android ç‰ˆæœ¬ï¼Œæ‰€ä»¥è¯·æ ¹æ®æ‚¨çš„ä»¿çœŸè®¾å¤‡çš„è§„æ ¼ä¸‹è½½æ­£ç¡®çš„åŒ…ã€‚

*   **æ‹¯æ•‘ APK(å®‰å“åŒ…):**

é€šè¿‡å·¥å…·æ ä¸­çš„ Open Gapps å°éƒ¨ä»¶ï¼Œå°†ç›®æ ‡åº”ç”¨ç¨‹åºå®‰è£…åˆ°ä»¿çœŸè®¾å¤‡å˜å¾—æ›´åŠ å®¹æ˜“ï¼Œå¦‚å›¾ 3 æ‰€ç¤ºã€‚

![](img/43940c7aa249e682dd345167d891bf70.png)

å›¾ 3ã€‚åœ¨ genymotion ä¸­å®‰è£… Gapps

å®‰è£…åï¼Œæ‚¨å¯ä»¥ç›´æ¥ä» Play Store ä¸‹è½½æ‚¨çš„ç›®æ ‡åº”ç”¨ç¨‹åºã€‚ä½†æ˜¯å°†è¿™ä¸ª apk ä¿å­˜åˆ°ä¸»æœºç³»ç»Ÿä¸­æ˜¯æœ‰ç›Šçš„ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªåŸå› :

1.  æ— éœ€å°†ç›¸åŒç‰ˆæœ¬çš„åº”ç”¨ç¨‹åºä¸‹è½½åˆ°å…·æœ‰ç›¸åŒè§„æ ¼çš„ä¸åŒä»¿çœŸè®¾å¤‡ä¸­ã€‚
2.  åç¼–è¯‘ç¨‹åºå®¡æŸ¥æºä»£ç è¿›è¡Œé™æ€åˆ†ææ‰€å¿…éœ€çš„ã€‚

é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•æ‹¯æ•‘ä»–ä»¬å‘¢ï¼Ÿ

é€šå¸¸ä½ æœ‰ä¸¤ç§æ–¹æ³•è·å¾— apkï¼Œè¦ä¹ˆä»åƒ evozi è¿™æ ·çš„ç½‘ç«™ä¸‹è½½ï¼Œè¦ä¹ˆä½¿ç”¨ adb (Android debug bridge)ä¸‹è½½

> **æ³¨æ„:** Genymotion å·²ç»åœ¨å®ƒçš„å®‰è£…ç›®å½•ä¸­é¢„è£…äº†è¿™ä¸ªå·¥å…·ï¼Œæˆ‘çš„ä½äº~/genymotion/tools/

å‡ºäºæ¼”ç¤ºç›®çš„ï¼Œæˆ‘å°†ä½¿ç”¨ Twitter Lite åº”ç”¨ç¨‹åº:

```
# Call package manager (pm) and filter out twitter's package name
$- **./adb shell pm list packages | grep twitter**# Check the absolute path 
$- **./adb shell pm path com.twitter.android.lite**# Pull apk and rename to twitter_lite.apk
$- **./adb pull /data/app/com.twitter.android.lite-somevalue.apk twitter_lite.apk**
```

![](img/277f68809e300a2e8e3c9ee218fc288e.png)

å›¾ 4ã€‚å°† apk ä» Genymotion ä¼ è¾“åˆ°ä¸»æœº

ç°åœ¨åªéœ€å°†è¿™äº› apk æ‹–æ”¾åˆ°ä»¿çœŸè®¾å¤‡ä¸­ã€‚

# 2.æ‰“å—ç»„æ›²

æˆ‘å‡è®¾è¯»è€…å·²ç»å®‰è£…äº† burp å¥—ä»¶ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆåªéœ€ä¸‹è½½å…¶ç¤¾åŒºç‰ˆæœ¬:[é“¾æ¥](https://portswigger.net/burp/releases/community/latest/)

> åœ¨è¿™é‡Œï¼Œæˆ‘å°†åªå‘ä½ å±•ç¤ºå¦‚ä½•é…ç½® android ä»¿çœŸè®¾å¤‡ã€‚

Android Nougat å’Œæ›´é«˜ç‰ˆæœ¬(API >= 24)ä»…ä¿¡ä»»ç³»ç»Ÿçº§ CA(è¯ä¹¦é¢å‘æœºæ„)è¯ä¹¦ï¼Œç”¨äºå®‰å…¨é€šä¿¡ï¼Œå°¤å…¶æ˜¯ WebViewã€‚ä½ å¯ä»¥ä»è¿™é‡Œäº†è§£æ›´å¤š:[é“¾æ¥](https://serializethoughts.com/2016/09/10/905)

å› æ­¤ï¼Œç»•è¿‡è¿™ä¸€é™åˆ¶çš„æœ€ç®€å•çš„æ–¹æ³•æ˜¯å®‰è£… Burp CA çš„è¯ä¹¦ä½œä¸ºç³»ç»Ÿä¿¡ä»»è¯ä¹¦ï¼Œè¿™ç§æ–¹æ³•ä¹Ÿå°†é˜²æ­¢æˆ‘ä»¬è®¾ç½®é”å®šå±å¹• PINğŸ˜

## æ­¥éª¤:

**1ã€‚**å°†æ‰“å— CA å¯¼å‡ºä¸º der æ ¼å¼

![](img/830ab98fd2e9f242a36c74d6cbae5915.png)

å›¾ 5ã€‚ä»¥ der æ ¼å¼å¯¼å‡º Burp CA çš„è¯ä¹¦

**2ã€‚**ä½¿ç”¨ [Openssl](https://github.com/openssl/openssl) å°† DER è½¬æ¢ä¸º PEM å¹¶é‡å‘½åä¸º<cert-hash>0

```
# Convert certificate format from DER to PEM
$- **openssl x509 -inform DER -in cacert.der -out cacert.pem**# Display the "hash" of the certificate subject name
$- **openssl x509 -inform PEM -subject_hash_old -in cacert.pem | head -1**# Move cert.pem and rename to <hash>.0
$- **mv cacert.pem 9a5ba575.0**
```

![](img/4b0ae0af58758d003d33059560beca0f.png)

å›¾ 6ã€‚ä½¿ç”¨ openssl å‡†å¤‡ Burp CA

> æ³¨æ„:å¦‚æœä½ çš„ openssl < 1.0ï¼Œä½¿ç”¨ **-subject_hash**

**3** ã€‚ä½¿ç”¨ adb åœ¨ä»¿çœŸè®¾å¤‡ä¸­ç§»åŠ¨è¯ä¹¦

```
# Change /system partition into writable mode with remount
$- **./adb remount**# Transfer certificate
$- **./adb push 9a5ba575.0 /system/etc/security/cacerts/**# Change its permissions
$- **./adb shell chmod 644 /system/etc/security/cacerts/9a5ba575.0**# Reboot to let changes occur
$- **./adb shell reboot**
```

![](img/807f06aedd040bf6167c1806f3f37508.png)

å›¾ 7ã€‚è½¬ç§»è¯ä¹¦

ç°åœ¨ï¼Œæ‚¨çš„è¯ä¹¦åº”è¯¥å®‰è£…ä¸ºç³»ç»Ÿä¿¡ä»»çš„ CA è¯ä¹¦ï¼Œæ‚¨å¯ä»¥é€šè¿‡å¯¼èˆªè¿›è¡Œç¡®è®¤:

è®¾ç½®â†’å®‰å…¨æ€§å’Œä½ç½®â†’åŠ å¯†å’Œå‡­è¯â†’å¯ä¿¡å‡­è¯

![](img/3dd08457e811aa223f5c0f679e8172e0.png)

å›¾ 8ã€‚ç¡®è®¤ Burp çš„è¯ä¹¦

**4ã€‚**é…ç½® burp suite çš„ä»£ç†

å¯¼èˆªåˆ°ä»£ç†â†’é€‰é¡¹â†’ä»£ç†ç›‘å¬ç¨‹åºâ†’æ·»åŠ 

![](img/41781f52d1385d7438ad3ad1b3b2eccc.png)

å›¾ 9ã€‚åœ¨ Burp ä¸­é…ç½®ä»£ç†

åœ¨è¿™é‡Œï¼Œæˆ‘å°†ç«¯å£ 8082 ç»‘å®šåˆ°æˆ‘çš„ VirtualBox çš„æ¥å£ IP

**5ã€‚**åœ¨ä»¿çœŸè®¾å¤‡ä¸Šï¼Œé…ç½® WiFi è®¾ç½®ã€‚

å¯¼èˆªåˆ° WiFi â†’é•¿æŒ‰ WiFi åç§°â†’ä¿®æ”¹ç½‘ç»œâ†’é«˜çº§é€‰é¡¹â†’å°†ä»£ç†æ— æ›´æ”¹ä¸ºæ‰‹åŠ¨

![](img/eb6e62bfb70dc35f0db8f4f2840290dc.png)

å›¾ 10ã€‚é…ç½® WiFi ç½‘ç»œ

ä¹‹åä½ å¯ä»¥åœ¨ burp çš„å†å²ä¸­çœ‹åˆ°ç½‘ç»œæµé‡

![](img/f59eca96bde8fd379462a5ab69aeb599.png)

å›¾ 11ã€‚æ‹¦æˆªæµé‡

# 3.å¼—é‡Œè¾¾

åŸºæœ¬ä¸Šï¼ŒFrida æ˜¯ä¸€ä¸ªåŠ¨æ€ä»£ç å·¥å…·å¥—ä»¶ï¼Œå®ƒå…è®¸æ‚¨åŠ¨æ€åœ°å°†ä»£ç ç‰‡æ®µæ³¨å…¥åˆ°åº”ç”¨ç¨‹åºçš„è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä»¥æ”¹å˜å…¶è¡Œä¸ºï¼Œè¿™æ­£æ˜¯æˆ‘ä»¬éœ€è¦ç»•è¿‡ SSL é”å®šçš„ï¼Œä½†ç°åœ¨æ‚¨å¯èƒ½ä¼šæƒ³çŸ¥é“è¿™æ˜¯ä»€ä¹ˆï¼Ÿ

SSL å›ºå®šæ˜¯ä¸€ç§åœ¨åº”ç”¨ä¸­ä½¿ç”¨çš„æŠ€æœ¯ï¼Œä½œä¸ºåº”ç”¨æµé‡çš„é™„åŠ å®‰å…¨å±‚ï¼Œä»¥é˜²æ­¢ MitM(ä¸­é—´äºº)ç­‰æ”»å‡»ï¼Œè¿™ä¸å…è®¸ burp æ‹¦æˆªæµé‡ï¼Œé™¤éæˆ‘ä»¬ä½¿ç”¨ Frida ç­‰å·¥å…·æ¥æŒ‚é’©ç»•è¿‡æ­¤åŠŸèƒ½çš„ç‰¹å®šä»£ç ã€‚

**å®‰è£…**

1.  ä½¿ç”¨ cli åœ¨ä¸»æœºä¸­å®‰è£…å¸¦æœ‰ pip3 çš„ frida-tools

```
$- **pip3 install frida-tools**
```

2.åªä¸‹è½½ x86 ç‰ˆæœ¬çš„ Frida æœåŠ¡å™¨ï¼Œå› ä¸º Genymotion çš„è™šæ‹Ÿè®¾å¤‡æ˜¯åŸºäº x86 çš„ï¼Œæ‚¨å¯ä»¥å¦‚å›¾ 12 æ‰€ç¤ºè¿›è¡ŒéªŒè¯ã€‚

![](img/7e3882698f653f9b00141aca12d0dedc.png)

å›¾ 12ã€‚ä¸‰æ˜Ÿ galaxy s9 (x86) arch

ä¸‹è½½[é“¾æ¥](https://github.com/frida/frida/releases)

```
# Downloading using wget as an example
$- **wget** [**https://github.com/frida/frida/releases/download/<version>/frida-server-<version>-android-x86.xz**](https://github.com/frida/frida/releases/download/12.11.9/frida-server-12.11.9-android-x86.xz)# Decompress using unxz
$- **unxz frida-server-<version>-android-x86.xz**# Rename for ease
$- **mv frida-server-<version>-x86.xz frida-server**# Transfer into the emulated device using adb
$- **./adb push ~/Downloads/frida-server /data/local/tmp**# Change its permissions
$- **./adb shell chmod 755 /data/local/tmp/frida-server**# Run Frida-server in the background
$- **./adb shell /data/local/tmp/frida-server &**
```

ç°åœ¨ï¼Œåœ¨è®¾ç½® Frida æœåŠ¡å™¨ä¹‹åï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿä½¿ç”¨æˆ‘ä»¬çš„è„šæœ¬ï¼Œä½†æ˜¯é¦–å…ˆæˆ‘ä»¬éœ€è¦æ‰¾åˆ° APK çš„åå­—ï¼Œä½ å¯ä»¥é€šè¿‡ä»»ä½•ä¸€ç§æ–¹å¼æ‰¾åˆ°å®ƒ

```
# Old method using pm
$- **./adb shell pm list packages | grep someapp**# Another way using Frida but for this app first need to be started
$- **frida-ps -U | grep someapp**
```

å‡ºäºæ¼”ç¤ºç›®çš„ï¼Œæˆ‘çš„ç›®æ ‡æ˜¯**s drill**ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯[**è¿™ä¸ª**](https://codeshare.frida.re/@sowdust/universal-android-ssl-pinning-bypass-2/) bypass è„šæœ¬ï¼Œåªéœ€å°†å®ƒä¿å­˜åˆ°ä¸€ä¸ª js æ–‡ä»¶ä¸­

ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹ Skrill æ˜¯å¦æŠ›å‡ºäº†ä»»ä½• SSL é”™è¯¯

![](img/8e3deebd6084fa6f91c5d28b534c8053.png)

å›¾ 13ã€‚Skrill æ­£åœ¨ä½¿ç”¨ SSL å›ºå®š

æ­£å¦‚é¢„æœŸçš„é‚£æ ·ï¼Œç°åœ¨ä½¿ç”¨ Frida å’Œä¸€ä¸ªæ—è·¯è„šæœ¬æ¥æ‹¦æˆªç½‘ç»œæµé‡

![](img/6fd3f3543074ec6f6770e9cef1c437a1.png)

å›¾ 14ã€‚æ—è·¯æˆåŠŸ

æ­£å¦‚ä½ ç°åœ¨çœ‹åˆ°çš„ï¼Œåœ¨ä½¿ç”¨ FRIDA æˆåŠŸç»•è¿‡ SSL pin ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­æµ‹è¯•ğŸ˜ƒ

# 4.å­—èŠ‚ç æŸ¥çœ‹å™¨

é™æ€åˆ†ææ˜¯ä¸€ä¸ªç®€å•çš„è¿‡ç¨‹ï¼Œå®ƒé€šè¿‡æ£€æŸ¥åº”ç”¨ç¨‹åºçš„æºä»£ç æ¥äº†è§£åº”ç”¨ç¨‹åºçš„æ‰§è¡Œæƒ…å†µã€‚ç„¶è€Œï¼Œåç¼–è¯‘å®ƒçš„æºä»£ç å¯èƒ½å¾ˆéš¾ï¼Œä¸ºæ­¤æœ‰ä¸€äº›åç¼–è¯‘ç¨‹åºï¼Œå¦‚ [jadx](https://github.com/skylot/jadx)

ä½†æ˜¯æˆ‘ä¸ªäººå–œæ¬¢[å­—èŠ‚ç æŸ¥çœ‹å™¨](https://github.com/Konloch/bytecode-viewer),å› ä¸ºå®ƒæœ‰å¤§é‡ä¸åŒçš„ Java åç¼–è¯‘å™¨ã€ä¸¤ä¸ªå­—èŠ‚ç ç¼–è¾‘å™¨å’Œè®¸å¤šå…¶ä»–ç‰¹æ€§ã€‚

ä¸‹è½½[é“¾æ¥](https://github.com/konloch/bytecode-viewer/releases)

ä¸‹è½½åï¼Œåªéœ€è¿è¡Œåç¼–è¯‘ç¨‹åºï¼Œå°†æ–‡ä»¶æ‹–æ”¾åˆ°æ–‡ä»¶éƒ¨åˆ†è¿›è¡Œåç¼–è¯‘ã€‚

![](img/14c44699f96e1e83cfe9c05a8147503e.png)

å›¾ 15ã€‚è¿è¡Œå­—èŠ‚ç æŸ¥çœ‹å™¨

æš‚æ—¶å°±è¿™æ ·äº†ğŸ˜ƒ

å¸Œæœ›è¿™èƒ½æ¶ˆé™¤ä½ çš„ä¸€äº›ç–‘è™‘ï¼Œè®©ä½ èƒ½å¤Ÿåˆ›å»ºè‡ªå·±çš„ android å®éªŒå®¤ã€‚

ç¥åœ£çµé™ä¸´èŠ‚å¿«ä¹ï¼