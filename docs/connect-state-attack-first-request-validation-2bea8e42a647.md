# è¿žæŽ¥çŠ¶æ€æ”»å‡»â€”é¦–æ¬¡è¯·æ±‚éªŒè¯

> åŽŸæ–‡ï¼š<https://infosecwriteups.com/connect-state-attack-first-request-validation-2bea8e42a647?source=collection_archive---------0----------------------->

HTTP ä¸»æœºå¤´çš„ä½œç”¨æ˜¯å¸®åŠ©è¯†åˆ«å®¢æˆ·ç«¯æƒ³è¦ä¸Žå“ªä¸ªåŽç«¯æœåŠ¡è¿›è¡Œé€šä¿¡ï¼Œæ­¤å¤–ï¼Œè®¸å¤šåº”ç”¨ç¨‹åºä¾èµ–ä¸»æœºå¤´æ¥ç”Ÿæˆå¯†ç é‡ç½®é“¾æŽ¥æˆ–é‡å®šå‘åœ°å€ç­‰ã€‚é€»è¾‘ç¼ºé™·æˆ–é”™è¯¯é…ç½®å¯èƒ½å¯¼è‡´ä¸åŒç±»åž‹çš„ HTTP ä¸»æœºæŠ¥å¤´æ”»å‡»ã€‚å…¶ä¸­ä¹‹ä¸€æ˜¯ HTTP è¿žæŽ¥è¯·æ±‚èµ°ç§ï¼Œå³ä»…åœ¨é€šè¿‡ HTTP è¿žæŽ¥å‘é€çš„ç¬¬ä¸€ä¸ªè¯·æ±‚ä¸­éªŒè¯ä¸»æœºå¤´ã€‚

![](img/08f0281bcf7ab9b4c547702ae328e146.png)

è¿™ç¯‡åšæ–‡å°†å¸¦æ‚¨é€šè¿‡ PortSwigger å®žéªŒå®¤äº†è§£ HTTP è¿žæŽ¥è¯·æ±‚èµ°ç§æ”»å‡»ã€‚

åœ¨å¼€å§‹ PortSwigger å®žéªŒä¹‹å‰ï¼Œæ‚¨éœ€è¦ç†Ÿæ‚‰ä¸€äº›æ¦‚å¿µã€‚

# 1.å¿…å¤‡çŸ¥è¯†

# 1.1 è™šæ‹Ÿä¸»æœº

åœ¨ä¸€ä¸ªç³»ç»Ÿæˆ– web æœåŠ¡å™¨ä¸Šæ‰˜ç®¡å¤šä¸ªç½‘ç«™æˆ–åº”ç”¨ç¨‹åºï¼Œå…±äº« CPU å’Œå†…å­˜ç­‰èµ„æºæ˜¯å¾ˆå¸¸è§çš„ã€‚ä»¥è¿™ç§æ–¹å¼æ‰˜ç®¡åœ¨ä¸€å°æœåŠ¡å™¨ä¸Šçš„ç½‘ç«™è¢«ç§°ä¸ºâ€œè™šæ‹Ÿä¸»æœºâ€ã€‚ç½‘ç«™æˆ–åº”ç”¨ç¨‹åºçš„è®¿é—®è€…é€šè¿‡ä»¥ä¸‹è™šæ‹Ÿä¸»æœºæ–¹æ³•è¢«è·¯ç”±åˆ°æ­£ç¡®çš„è™šæ‹Ÿä¸»æœº:

*   åŸºäºŽ IP çš„

åŸºäºŽ IP çš„è™šæ‹Ÿä¸»æœºè¦æ±‚æ¯ä¸ªè™šæ‹Ÿä¸»æœºæœ‰ä¸€ä¸ªä¸“ç”¨çš„ IP åœ°å€ã€‚è¿™æ˜¯é€šè¿‡ä¸ºå•ä¸ª web æœåŠ¡å™¨åˆ›å»ºå¤šä¸ª IP åœ°å€æ¥å®žçŽ°çš„ã€‚

*   åŸºäºŽç«¯å£çš„

åŸºäºŽç«¯å£çš„è™šæ‹Ÿä¸»æœºä½¿ç”¨ä¸åŒçš„ç«¯å£ï¼Œweb æœåŠ¡å™¨è¢«é…ç½®ä¸ºé€šè¿‡ç«¯å£å°†æµé‡è·¯ç”±åˆ°è™šæ‹Ÿä¸»æœºã€‚

*   åŸºäºŽåç§°çš„

åŸºäºŽåç§°çš„è™šæ‹Ÿä¸»æœºå…è®¸ä¸€ä¸ª IP åœ°å€æ‰˜ç®¡å¤šä¸ªç½‘ç«™ã€‚æµé‡åœ¨ HTTP è¯·æ±‚ä¸­æŒ‰ä¸»æœºåè·¯ç”±ã€‚è¿™ç§æ–¹æ³•è¦æ±‚å®¢æˆ·ç«¯å¿…é¡»æ”¯æŒ HTTP 1.1(æˆ–å¸¦æœ‰ 1.1 æ‰©å±•çš„ HTTP 1.0)ã€‚

# 1.2 é€šè¿‡ä¸­é—´è®¾å¤‡è·¯ç”±æµé‡

å¦ä¸€ç§å¸¸è§çš„æƒ…å†µæ˜¯ï¼Œä¸åŒçš„ç½‘ç«™æ‰˜ç®¡åœ¨ä¸åŒçš„åŽç«¯æœåŠ¡å™¨ä¸Šï¼Œä½†å®ƒä»¬éƒ½è¦é€šè¿‡ä¸­é—´è®¾å¤‡æ‰èƒ½åˆ°è¾¾ç›®æ ‡åŽç«¯æœåŠ¡å™¨ã€‚é€šå¸¸ï¼Œåå‘ä»£ç†æœåŠ¡å™¨å’Œè´Ÿè½½å¹³è¡¡å™¨å¯ä»¥å……å½“è¿™æ ·çš„ä¸­ä»‹ï¼Œä½äºŽè¯·æ±‚è·¯å¾„ä¸­ã€‚è¿™ç§è®¾è®¡å…è®¸å¤šä¸ªç½‘ç«™è¢«è§£æžåˆ°ä¸­é—´ç»„ä»¶çš„å•ä¸ª IP åœ°å€ï¼Œè¯·æ±‚è¢«ç›¸åº”åœ°åˆ†å‘åˆ°ä¸­é—´ç»„ä»¶åŽé¢çš„é¢„æœŸåŽç«¯æœåŠ¡å™¨ã€‚ä¸ºäº†å®žçŽ°è¿™ä¸€ç‚¹ï¼Œè·¯ç”±å¯ä»¥åŸºäºŽè¯·æ±‚ä¸­çš„ä¸»æœºåã€‚

![](img/5f4f6b9e2718f9ede315468fa5264bd6.png)

# 1.3 ä¸»æœºæ ‡é¢˜

ä¸»æœºæŠ¥å¤´å¯¹äºŽåŸºäºŽåç§°çš„è™šæ‹Ÿä¸»æœºå’Œé€šè¿‡ä¸­é—´è®¾å¤‡çš„åŸºäºŽä¸»æœºçš„è·¯ç”±éžå¸¸é‡è¦ï¼Œä»¥ä¾¿çŸ¥é“è¯·æ±‚åˆ°è¾¾åŽå°†æµé‡è½¬å‘åˆ°å“ªé‡Œã€‚å½“ç”¨æˆ·è®¿é—®ç½‘ç«™æ—¶ï¼ŒURL å°†è§£æžä¸ºç‰¹å®šæœåŠ¡å™¨æˆ–ä¸­é—´è®¾å¤‡çš„ IP åœ°å€ã€‚åœ¨è¯·æ±‚ä¸­ï¼Œä¸»æœºå¤´æŒ‡å®šå®¢æˆ·ç«¯æƒ³è¦è®¿é—®çš„åŸŸåã€‚

# 1.4 HTTP ä¸»æœºæŠ¥å¤´æ”»å‡»

ç”±äºŽä¸»æœºå¤´å®žé™…ä¸Šæ˜¯ç”¨æˆ·å¯æŽ§åˆ¶çš„ï¼Œè¿™ç§åšæ³•ä¼šå¯¼è‡´è®¸å¤šé—®é¢˜ã€‚HTTP ä¸»æœºæ ‡å¤´æ”»å‡»åˆ©ç”¨æ˜“å—æ”»å‡»çš„ç½‘ç«™ï¼Œè¿™äº›ç½‘ç«™ä¿¡ä»»ä¸»æœºæ ‡å¤´è€Œä¸æ­£ç¡®éªŒè¯å®ƒã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ç•¸å½¢æˆ–å¤åˆ¶ç¯¡æ”¹ä¸»æœºå¤´ï¼Œæ“çºµåŽç«¯æœåŠ¡å™¨çš„è¡Œä¸ºã€‚å…¬å¸æœ‰æ—¶ä¼šåœ¨åŒä¸€æœåŠ¡å™¨ä¸Šæ‰˜ç®¡å¯å…¬å¼€è®¿é—®çš„ç½‘ç«™å’Œå†…éƒ¨ç½‘ç«™ï¼Œæ”»å‡»è€…å¯èƒ½èƒ½å¤Ÿé€šè¿‡ä¸»æœºæ ‡é¢˜æ“ä½œæ¥è®¿é—®å†…éƒ¨ç½‘ç«™ã€‚

# 1.5 ä¿æŒæ´»åŠ¨è¿žæŽ¥

TCP è¿žæŽ¥æ˜¯é€šè¿‡ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹çš„ï¼Œå®ƒè¦æ±‚æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯åœ¨ä¼ è¾“æ•°æ®ä¹‹å‰äº¤æ¢ SYN å’Œ ACK æ•°æ®åŒ…ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒHTTP è¿žæŽ¥åœ¨æ¯æ¬¡è¯·æ±‚åŽå…³é—­ï¼Œä¸‹ä¸€æ¬¡è¯·æ±‚å°†å»ºç«‹æ–°çš„è¿žæŽ¥ã€‚æ¡æ‰‹ä¼šå¯¼è‡´è¿žæŽ¥å¼€é”€ï¼Œå¹¶é™ä½Žæ•´ä¸ªè¿žæŽ¥è¿‡ç¨‹çš„é€Ÿåº¦ã€‚ä¸ºäº†æé«˜æ€§èƒ½ï¼ŒHTTP keep-alive å¤´ä¿æŒ TCP å¥—æŽ¥å­—/è¿žæŽ¥æ‰“å¼€ï¼Œå¹¶å…è®¸å¤šä¸ªè¯·æ±‚å’Œå“åº”é‡ç”¨ä¸€ä¸ªå·²å»ºç«‹çš„ TCP è¿žæŽ¥ã€‚

ç¦ç”¨å’Œå¯ç”¨ä¿æ´»æ—¶çš„å·¥ä½œæµ(ä¸åŒ…æ‹¬ SSL æ¡æ‰‹)å¦‚ä¸‹æ‰€ç¤º:

![](img/9efec918f0519abaf57efaf7543853e9.png)

æ‚¨å¯ä»¥ä½¿ç”¨ cURL å‘½ä»¤æ¥æ›´å¥½åœ°ç†è§£é‡ç”¨åŒä¸€ä¸ªè¿žæŽ¥å¦‚ä½•å‡å°‘è¿žæŽ¥å»¶è¿Ÿã€‚

è¦æµ‹é‡å‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚éœ€è¦å¤šé•¿æ—¶é—´ï¼Œå¯ä»¥åœ¨ cURL å‘½ä»¤ä¸­æŒ‡å®šæ—¶é—´ã€‚

**time_connect** æ˜¯å®¢æˆ·ç«¯è§’åº¦çš„ TCP ä¸‰æ¬¡æ¡æ‰‹ã€‚ **time_appconnect** è¿™é‡Œæ˜¯ TLS è®¾ç½®ã€‚ **time_starttransfer** å°±åœ¨ cURL ä»Žç½‘ç»œä¸­è¯»å–ç¬¬ä¸€ä¸ªå­—èŠ‚ä¹‹å‰(å®ƒå®žé™…ä¸Šè¿˜æ²¡æœ‰è¯»å–)ã€‚

å‘å‡ºå¦‚ä¸‹ç±»ä¼¼çš„ cURL å‘½ä»¤:

```
# curl -v -s -w "TCP time: %{time_connect}, TLS setup time: %{time_appconnect}, Time to first byte: %{time_starttransfer}\n\n"   -o /dev/null [https://example.com/](https://example.com/) -o /dev/null [https://example.com/](https://example.com/)
*   Trying ***:443...
* Connected to example.com (***) port 443 (#0)
* schannel: disabled automatic use of client certificate
* ALPN: offers http/1.1
* ALPN: server did not agree on a protocol. Uses default.
> GET / HTTP/1.1
> Host: example.com
> User-Agent: curl/7.83.1
> Accept: */*
>
* Mark bundle as not supporting multiuse
< HTTP/1.1 200 OK
...
< Keep-Alive: timeout=10
< Content-Length: 0
<
* Connection #0 to host example.com left intact
TCP time: 0.571379, TLS setup time: 1.441327, Time to first byte: 1.867394
â€‹
* Found bundle for host: 0x1bcf22be890 [serially]
* Re-using existing connection #0 with host example.com
* Connected to example.com (***) port 443 (#0)
> GET / HTTP/1.1
> Host: example.com
> User-Agent: curl/7.83.1
> Accept: */*
>
* Mark bundle as not supporting multiuse
< HTTP/1.1 200 OK
...
< Keep-Alive: timeout=10
< Content-Length: 0
<
* Connection #0 to host example.com left intact
TCP time: 0.005519, TLS setup time: 0.005520, Time to first byte: 0.428777
```

æ£€æŸ¥ curl å‘½ä»¤çš„ç»“æžœï¼Œæ‚¨å¯ä»¥çœ‹åˆ°è¿žæŽ¥# 0 æ˜¯åœ¨ç¬¬ä¸€ä¸ªè¯·æ±‚ä¸­åˆ›å»ºçš„ï¼Œå¹¶è¢«ç¬¬äºŒä¸ªè¯·æ±‚é‡ç”¨ã€‚åŒä¸€è¿žæŽ¥ä¸­ä¸¤ä¸ªè¯·æ±‚çš„è¿žæŽ¥æ—¶é—´æ¦‚è¿°å¦‚ä¸‹:

```
...
TCP time: 0.571379, TLS setup time: 1.441327, Time to first byte: 1.867394
...
TCP time: 0.005519, TLS setup time: 0.005520, Time to first byte: 0.428777
```

ç¬¬ä¸€ä¸ª TCP è¿žæŽ¥æ—¶é—´æ˜¯ 0.571379 ç§’ï¼Œç¬¬äºŒä¸ªè¯·æ±‚æ€»å…±åªéœ€è¦ 0.005519 ç§’ã€‚

ä½†å¹¶ä¸æ˜¯æ‰€æœ‰çš„æœåŠ¡å™¨éƒ½å¯ç”¨äº† keepaliveï¼Œå› ä¸ºç¦ç”¨ keepalive æ˜¯ä¸€ç§å‡ç¼“æ»¥ç”¨å®¢æˆ·ç«¯é€Ÿåº¦ä»¥å‡å°‘ä¸€äº›æ”»å‡»æµé‡çš„è§£å†³æ–¹æ¡ˆã€‚

# 2.è¿žæŽ¥çŠ¶æ€æ”»å‡»-é¦–æ¬¡è¯·æ±‚éªŒè¯

åœ¨è¿žæŽ¥çŠ¶æ€æ”»å‡»ä¸­ï¼Œä¸€äº›åº”ç”¨ç¨‹åºåªå¯¹è¿žæŽ¥ä¸­çš„ç¬¬ä¸€ä¸ªè¯·æ±‚æ‰§è¡Œä¸»æœºå¤´éªŒè¯ã€‚è¿™æ„å‘³ç€æ”»å‡»è€…å¯ä»¥é€šè¿‡å‘åˆæ³•çš„ä¸»æœºåå‘å‡ºè¯·æ±‚ï¼Œç„¶åŽé€šè¿‡ç›¸åŒçš„è¿žæŽ¥å‘å†…éƒ¨ç½‘ç«™å‘å‡ºè¯·æ±‚ï¼Œæ¥èŽ·å¾—å¯¹å†…éƒ¨ç½‘ç«™çš„è®¿é—®æƒé™ã€‚portswigger ç«™ç‚¹ä¸­çš„è¿žæŽ¥çŠ¶æ€æ”»å‡»å®žéªŒå®¤æ˜“å—åŸºäºŽè·¯ç”±çš„ SSRF çš„æ”»å‡»ï¼Œæ‚¨å¯ä»¥èŽ·å¾—å®žéªŒå®¤çš„[æ¡ç›®](https://portswigger.net/web-security/host-header/exploiting#connection-state-attacks)ã€‚çŽ°åœ¨æˆ‘ä»¬å°†ä¸€èµ·æµè§ˆå®žéªŒå®¤ã€‚

å½“ç”¨æˆ·è®¿é—®æ˜“å—æ”»å‡»çš„ç½‘ç«™æ—¶ï¼Œä½¿ç”¨ burpsuite æ•èŽ·`GET /`è¯·æ±‚ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºè¯·æ±‚#1:

![](img/c1c2d090f752222c328a81542ab94da4.png)

å°†ä¸Šé¢çš„è¯·æ±‚å¤åˆ¶ä¸ºè¯·æ±‚#2ï¼Œå¹¶å°†è¯·æ±‚çš„è·¯å¾„è®¾ç½®ä¸º/adminï¼Œå°†ä¸»æœºå¤´è®¾ç½®ä¸º`192.168.0.1`ï¼Œå‘é€è¯·æ±‚ã€‚

æ®è§‚å¯Ÿï¼Œæ‚¨åªæ˜¯è¢«é‡å®šå‘åˆ°ä¸»é¡µã€‚

![](img/98a64cc5e5767bafd34c55307439f97f.png)

çŽ°åœ¨åˆ›å»ºä¸€ä¸ªé€‰é¡¹å¡ç»„ï¼Œå°†è¯·æ±‚#1 å’Œè¯·æ±‚#2 æ”¾åœ¨ä¸€èµ·ã€‚

![](img/cb61d1e9144a6c4adb9418221483813c.png)

å°†é€‰é¡¹å¡ç»„å‘½åä¸º Group 1ï¼Œå¹¶å°†è¯·æ±‚#1 å’Œè¯·æ±‚#2 æ·»åŠ åˆ°è¯¥ç»„ä¸­ã€‚

![](img/783e1f3e6a44e857e31651abafc3995b.png)![](img/7e4abcd91d693c9c7c77ab4c107eddd3.png)

é€‰æ‹©â€œæŒ‰é¡ºåºå‘é€ç»„(å•ä¸ªè¿žæŽ¥)â€ï¼Œå°†è¿™ä¸¤ä¸ªè¯·æ±‚æ”¾åœ¨ä¸€ä¸ª HTTP è¿žæŽ¥ä¸­ã€‚

å°†ä¸¤ä¸ªè¯·æ±‚ä¸­çš„è¿žæŽ¥æ›´æ”¹ä¸º keep-aliveï¼Œå¹¶å•å‡»â€œæŒ‰é¡ºåºå‘é€ç»„(å•ä¸ªè¿žæŽ¥)â€æŒ‰é’®ã€‚å¯ä»¥çœ‹åˆ°ï¼Œç¬¬äºŒä¸ªè¯·æ±‚å·²ç»æˆåŠŸåœ°è®¿é—®äº†å†…éƒ¨ç®¡ç†é¢æ¿ã€‚

![](img/5230e829b0d8dccc5db158a8e83d9d1b.png)

åŽŸå› æ˜¯è¯·æ±‚#1 ä¸­çš„ä¸»æœºæŠ¥å¤´é€šè¿‡äº†éªŒè¯ï¼Œä½†æ˜¯éªŒè¯æ²¡æœ‰åº”ç”¨åˆ°ä¸Žè¯·æ±‚#1 ç›¸åŒçš„ HTTP è¿žæŽ¥ä¸‹çš„åŽç»­è¯·æ±‚ï¼Œå› æ­¤å½“è¯·æ±‚#2 ä¸­çš„ä¸»æœºæŠ¥å¤´è¢«ç¯¡æ”¹æ—¶ï¼Œè¯·æ±‚#2 è¢«æˆåŠŸè·¯ç”±åˆ°å†…éƒ¨ç½‘ç«™ 192.168.0.1ï¼Œç®¡ç†é¢æ¿æš´éœ²ç»™æœ€ç»ˆç”¨æˆ·ã€‚

æ‚¨å¯ä»¥æŒ‰ç…§ portswigger ç«™ç‚¹ä¸­çš„è§£å†³æ–¹æ¡ˆæ¥å®Œæˆå®žéªŒã€‚

# æœ€åŽçš„æƒ³æ³•

å¦‚æžœæ‚¨æœ‰ä»»ä½•é—®é¢˜æˆ–åé¦ˆï¼Œè¯·éšæ—¶å‘è¡¨è¯„è®ºã€‚å¦‚æžœä½ è®¤ä¸ºè¿™ç¯‡åšæ–‡æœ‰å¸®åŠ©ï¼Œè¯·ç‚¹å‡»æ‹æ‰‹ðŸ‘æŒ‰é’®ä¸‹é¢å‡ ä¸‹ï¼Œä»¥ç¤ºæ”¯æŒï¼

## æ¥è‡ª Infosec çš„æŠ¥é“:Infosec æ¯å¤©éƒ½æœ‰å¾ˆå¤šå†…å®¹ï¼Œå¾ˆéš¾è·Ÿä¸Šã€‚[åŠ å…¥æˆ‘ä»¬çš„æ¯å‘¨ç®€è®¯](https://weekly.infosecwriteups.com/)ä»¥ 5 ç¯‡æ–‡ç« ã€4 ä¸ªçº¿ç¨‹ã€3 ä¸ªè§†é¢‘ã€2 ä¸ª GitHub Repos å’Œå·¥å…·ä»¥åŠ 1 ä¸ªå·¥ä½œæé†’çš„å½¢å¼å…è´¹èŽ·å–æ‰€æœ‰æœ€æ–°çš„ Infosec è¶‹åŠ¿ï¼