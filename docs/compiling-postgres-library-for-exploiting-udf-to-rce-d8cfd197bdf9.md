# ä¸ºå¼€å‘ UDF åˆ° RCE è€Œç¼–å†™ Postgres å›¾ä¹¦é¦†

> åŸæ–‡ï¼š<https://infosecwriteups.com/compiling-postgres-library-for-exploiting-udf-to-rce-d8cfd197bdf9?source=collection_archive---------0----------------------->

æˆ‘æœ€è¿‘å‚åŠ äº† WEB-300 è¯¾ç¨‹å¹¶é€šè¿‡äº† OSWE è€ƒè¯•ã€‚WEB-300 è¯¾ç¨‹æ¨¡å—åŒ…æ‹¬ UDF åå‘å¤–å£³ã€‚æˆ‘å‘ç°å›°éš¾çš„ä¸€ä»¶äº‹æ˜¯å¦‚ä½•ä¸º postgres çš„ç‰¹å®šç‰ˆæœ¬ç¼–è¯‘åº“ä»¥ç”¨äº UDFã€‚æ‰€ä»¥æˆ‘å†³å®šåˆ†äº«æˆ‘æ‰€å­¦åˆ°çš„ã€‚

[](https://www.offensive-security.com/awae-oswe/) [## é«˜çº§ç½‘ç»œæ”»å‡»å’Œåˆ©ç”¨(AWAE) |æ”»å‡»æ€§å®‰å…¨

### äº†è§£é«˜çº§ web æ”»å‡»å’Œåˆ©ç”¨ä¸­çš„ç™½ç›’ Web åº”ç”¨ç¨‹åºå®‰å…¨æµ‹è¯•(WEB-300)ã€‚å®Œæˆè¯¾ç¨‹å¹¶â€¦

www.offensive-security.com](https://www.offensive-security.com/awae-oswe/) 

## æˆ‘ä¸ºä»€ä¹ˆå†™è¿™ä¸ªï¼Ÿ

è¿™æœ‰ä¸¤ä¸ªåŸå› :

1.  å¼€å‘è¿‡ç¨‹ä¸­æ‰€éœ€çš„åº“ä¾èµ–äºå¹³å°ã€‚ä½ ä¸èƒ½è¿è¡Œåœ¨ linux æ“ä½œç³»ç»Ÿä¸Šç¼–è¯‘çš„åº“æ¥åˆ©ç”¨è¿è¡Œåœ¨ windows ä¸Šçš„ postgresï¼Œåä¹‹äº¦ç„¶
2.  åŒæ—¶ï¼Œå›¾ä¹¦é¦†ä¾èµ–äº postgres çš„ä¸»è¦ç‰ˆæœ¬

**æ³¨æ„:å¦‚æœ postgres ç‰ˆæœ¬é«˜äº 9.3 å¹¶ä¸”å¤åˆ¶åŠŸèƒ½åœ¨éœ€è¦çš„æƒé™ä¸‹å¯ç”¨ï¼Œå¯ä»¥ä½¿ç”¨**[**payload all things command injection**](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/PostgreSQL%20Injection.md#postgresql-command-execution)**è·å¾—ä¸€ä¸ªåå‘ shellï¼Œè€Œä¸å¿…ä¸º UDF è€Œçƒ¦æ¼:)**

## åœ¨ Linux ä¸Šç¼–è¯‘åº“

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†åœ¨ kali ä¸Šä½¿ç”¨ dockerï¼Œä»¥é¿å…æä¹±ä¸»æœºé…ç½®å’Œæ–‡ä»¶( ***)æˆ‘é¦–å…ˆå°è¯•åœ¨ä¸»æœºä¸Šè¿™æ ·åšï¼Œå¯¼è‡´æˆ‘çš„æœºå™¨å´©æºƒã€‚è°¢å¤©è°¢åœ°ï¼Œæˆ‘æœ‰é‡è¦ä¸œè¥¿çš„å¤‡ä»½ã€‚*** )

1.  å¦‚æœä½ è¿˜æ²¡æœ‰å®‰è£… dockerï¼Œè¿™ä¸ªé“¾æ¥ä¼šä¸ºä½ è§£é‡Šæ¸…æ¥š[https://airman 604 . medium . com/installing-docker-in-kali-Linux-2017-1-FBA a4 d 1447 Fe](https://airman604.medium.com/installing-docker-in-kali-linux-2017-1-fbaa4d1447fe)
2.  è®©æˆ‘ä»¬ç”¨ *docker pull postgres:10.18 æ¥æ‹‰ä¸€ä¸‹ postgres ä¸»è¦ç‰ˆæœ¬çš„ docker é•œåƒã€‚å¦‚æœä½ å·²ç»å¼€å‘äº† sql æ³¨å…¥ï¼Œä½ å¯ä»¥å¾ˆå®¹æ˜“åœ°æ‰¾åˆ° postgres ç‰ˆæœ¬*

![](img/c42c724f4a01bec101661ab463d3dbf3.png)

3.åœ¨ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ª postgres-data ç›®å½•ï¼Œå¹¶å°†å…¶æŒ‚è½½ä¸ºå®¹å™¨çš„æ•°æ®å·ï¼Œä»¥å­˜å‚¨æ‰€æœ‰æ•°æ®åº“æ–‡ä»¶

```
rootğŸ’€osboxes)-[/home/osboxes]
â””â”€# **mkdir postgres-data**
```

4.ä½¿ç”¨å‘½ä»¤è¿è¡Œ docker å®¹å™¨ï¼Œå°†æ•°æ®å·æ˜ å°„åˆ°å®¹å™¨ ***udf-postgres*** ï¼Œå°†å¯†ç è®¾ç½®ä¸º ***noob@123*** ï¼Œå¹¶å°†ç«¯å£æ˜ å°„åˆ° 5432

```
â”€â”€(rootğŸ’€osboxes)-[/home/osboxes]
â””â”€# d**ocker run -d --name udf-postgres -e POSTGRES_PASSWORD=noob@123 -v /home/osboxes/postgres-data/:/var/lib/postgresql/data -p 5432:5432 postgres:10.18**    
92212e425db4ce74108a95d9a891ca1233979c470d2bb2fa58092618ef7f73f1

â”Œâ”€â”€(rootğŸ’€osboxes)-[/home/osboxes]
â””â”€# **docker ps**                                                                                                                                           
CONTAINER ID   IMAGE            COMMAND                  CREATED          STATUS          PORTS                                       NAMES
92212e425db4   postgres:10.18   "docker-entrypoint.sâ€¦"   14 seconds ago   Up 12 seconds   0.0.0.0:5432->5432/tcp, :::5432->5432/tcp   udf-postgres
```

5.Exec è¿›å…¥æ­£åœ¨è¿è¡Œçš„å®¹å™¨

```
â”Œâ”€â”€(rootğŸ’€osboxes)-[/home/osboxes]
â””â”€# **docker exec -it udf-postgres bash**                                                                                                                               
root@92212e425db4:/#
```

6.è¿è¡Œ ***apt-get æ›´æ–°*** å’Œ ***apt-get å®‰è£… PostgreSQL-server-dev-10****(ä½¿ç”¨ dev-10 è€ƒè™‘åˆ° postgres çš„ä¸»è¦ç‰ˆæœ¬)ã€‚æˆ‘ä»¬éœ€è¦å®‰è£… postgresql-server-dev causeï¼Œå®ƒåŒ…å«ç¼–è¯‘ UDF æ‰€éœ€çš„åº“*

```
root@92212e425db4:/# **apt-get update**

Fetched 8,448 kB in 5s (1,491 kB/s)                                   
Reading package lists... Doneroot@92212e425db4:/# **apt-get install postgresql-server-dev-10**
```

7.å°† gcc å®‰è£…åœ¨å®¹å™¨å†…

```
root@92212e425db4:/# **apt install gcc**
```

8.ä»è¿™ä¸ª github åº“[https://github.com/Dionach/pgexec/blob/master/pg_exec.c](https://github.com/Dionach/pgexec/blob/master/pg_exec.c)ä¸‹è½½ pg_exec.cï¼Œå¹¶ç§»åŠ¨åˆ°æ˜ å°„åˆ°å®¹å™¨å·çš„ **postgres-data** ç›®å½•

```
â”Œâ”€â”€(rootğŸ’€osboxes)-[/home/osboxes/postgres-data]
â””â”€# **ls -la *.c**
-rw-r--r-- 1 root root 255 Nov 20 04:58 pg_exec.c
```

9.æ‰¾åˆ° **postgres.h** åº“ï¼Œå› ä¸ºå®ƒæ˜¯ç¼–è¯‘æ‰€éœ€è¦çš„

```
root@92212e425db4:/# **find / -iname postgres.h 2>/dev/null**
/usr/include/postgresql/10/server/postgres.h
```

10.cd åˆ°å®¹å™¨å†…çš„æ˜ å°„ç›®å½•ï¼Œå³ **/var/lib/postgresql/data** ã€‚è¿™å°±æ˜¯æˆ‘ä»¬çš„ **pg_exec.c** æ–‡ä»¶æ‰€åœ¨çš„ä½ç½®

![](img/a00c999406d63d1082a2504c164ae937.png)

11.ç°åœ¨å°† **pg_exec.c** ç¼–è¯‘æˆä¸€ä¸ªã€‚æ‰€ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å½’æ¡£

```
root@92212e425db4:/var/lib/postgresql/data# **gcc -I /usr/include/postgresql/10/server/ -shared -fPIC -o pg_exec.so pg_exec.c**
```

12.æ‚¨å¯ä»¥åœ¨ä¸»æœºæœåŠ¡å™¨çš„ postgres-data ç›®å½•ä¸­æ‰¾åˆ°ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶ **pg_exec.so**

![](img/fbb7d9a395d79c077c9ef103e3046433.png)

ç°åœ¨å‰©ä¸‹çš„å°±æ˜¯ä½¿ç”¨å‘ç°çš„ sql æ³¨å…¥å°†ç”Ÿæˆçš„ **pg_exec.so** ä¼ è¾“åˆ°ç›®æ ‡ç³»ç»Ÿï¼Œå¹¶å°†å®ƒä»¬å­˜å‚¨åœ¨ postgres å¤§å‹å¯¹è±¡ä¸­ã€‚ç¨åï¼Œå°†ç›¸åŒçš„äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶åˆ°ç›®æ ‡ä¸Šçš„æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œä»¥ä¾› UDF è°ƒç”¨ã€‚ä¸€æ—¦ä½ æœ‰äº†æ­£ç¡®çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¿™é‡Œæœ‰ä¸€äº›èµ„æºå¯ä»¥å¸®åŠ©ä½ è·å¾—åå‘ shell

[](https://blog.pentesteracademy.com/postgresql-udf-command-execution-372f0c68cfed) [## PostgreSQL UDF å‘½ä»¤æ‰§è¡Œ

### Metasploit æ¡†æ¶æ˜¯æœ€æµè¡Œå’Œæœ€å¼ºå¤§çš„ç½‘ç»œæ¸—é€æµ‹è¯•å·¥å…·ï¼Œå¹¿æ³›åº”ç”¨äºâ€¦

blog.pentesteracademy.com](https://blog.pentesteracademy.com/postgresql-udf-command-execution-372f0c68cfed)  [## PostgreSQL 9.x è¿œç¨‹å‘½ä»¤æ‰§è¡Œ- Dionach

### åœ¨æœ€è¿‘çš„ä¸€æ¬¡æ¸—é€æµ‹è¯•ä¸­ï¼Œæˆ‘èƒ½å¤Ÿè®¿é—® PostgreSQL 9.0 æœåŠ¡ã€‚è€Œæ‰§è¡Œçš„è¿‡ç¨‹â€¦

www.dionach.com](https://www.dionach.com/blog/postgresql-9-x-remote-command-execution/) 

æ„Ÿè°¢é˜…è¯»ã€‚è®©æˆ‘çŸ¥é“ï¼Œå¦‚æœä½ å‘ç°ä»»ä½•å›°éš¾å¤åˆ¶ä¸Šè¿°æ­¥éª¤ï¼Œå°†å¾ˆä¹æ„æ¸…é™¤æ‚¨çš„ç–‘é—®ã€‚å¦å¤–ï¼Œå¦‚æœä½ éœ€è¦ä¸€æ­¥ä¸€æ­¥çš„æŒ‡å¯¼æ¥åˆ›å»ºä¸€ä¸ªç”¨äº UDF -> RCE æ¼æ´çš„çª—å£ DLLï¼Œè¯·åœ¨è¯„è®ºä¸­ç•™è¨€ã€‚

åœ¨ LinkedIn[https://www.linkedin.com/in/niraj-kumar-choubey-7351b892/](https://www.linkedin.com/in/niraj-kumar-choubey-7351b892/)ä¸Šä¸æˆ‘è”ç³»ï¼Œæ‰“æ‹›å‘¼æˆ–è®¨è®ºä»»ä½•ç½‘ç»œå®‰å…¨é—®é¢˜ã€‚